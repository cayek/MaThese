# -*- coding: utf-8 -*-
# -*- mode: org -*-

# beamer
#+startup: beamer
#+LaTeX_CLASS: beamer
#+LaTeX_CLASS_OPTIONS: [aspectratio=169, xcolor={table}]
#+BEAMER_FRAME_LEVEL: 2
#+OPTIONS: H:2 toc:nil num:nil
#+latex_header: \usepackage[citestyle=authoryear, bibstyle=authoryear, hyperref=true,backref=true,maxcitenames=2,url=true,backend=biber,natbib=true]{biblatex}
#+latex_header: \addbibresource{../biblio.bib}
#+LATEX_HEADER: \input{../packages.tex}
#+LATEX_HEADER: \input{../setup.tex}
#+LATEX_HEADER: \input{../notations.tex}


#+TITLE: Méthodes de factorisation matricielle pour la génomique des populations et les tests d'association
#+AUTHOR: Kévin CAYE
#+LANGUAGE: fr
#+STARTUP: overview indent inlineimages logdrawer
#+TAGS: noexport(n)
#+EXPORT_SELECT_TAGS: export
#+EXPORT_EXCLUDE_TAGS: noexport
#+COLUMNS: %25ITEM %TODO %3PRIORITY %TAGS
#+SEQ_TODO: TODO(t!) STARTED(s!) WAITING(w!) RUNNING(r!) DEBUG(g!) APPT(a!) | DONE(d!) CANCELLED(c!) DEFERRED(f!)

# reveal
#+REVEAL_ROOT: ./
#+REVEAL_TRANS: none
#+OPTIONS: reveal_mathjax:t reveal_slide_number:h.v/t reveal_history:t
#+OPTIONS: reveal_title_slide:nil reveal_center:nil
#+OPTIONS: reveal_width:1200 reveal_height:800
#+REVEAL_THEME: cayek_solarized
#+REVEAL_HLEVEL: 0 ## all header on same lvl
#+REVEAL_SPEED: fast
#+REVEAL_EXTRA_CSS: ./local.css

#+PROPERTY: header-args :exports none :eval no-export :session *R* :dir ~/Projects/Thesis/MaThese/Slides :results silent

# title
#+BEGIN_EXPORT html
<section>
	<h1 style="-webkit-hyphens:none;-moz-hyphens:none;hyphens:none;"> <strong>Méthodes de
	factorisation matricielle pour la génomique des populations et les tests
	d'association</strong><br/>
	<h3 style="margin-top:50px;">Kévin CAYE</h3>
	<footer>
		<div>
			Thèse dirigée par Olivier FRANÇOIS <br/>
      et co-encadrée par Olivier MICHEL et Jean-Luc BOSSON
		</div>
	  <img src="img/logo/logo-comue.png" class="ugaLogo"/>
	</footer>
	<aside class="notes">
    Intro
  </aside>
</section>
#+END_EXPORT

* Install                                                          :noexport:
Install with spacemacs see [[https://github.com/syl20bnr/spacemacs/tree/master/layers/%252Bemacs/org#revealjs-support][Reveal.js support]].
Some sources: 
- [[http://jr0cket.co.uk/2013/10/create-cool-slides--Org-mode-Revealjs.html.html][Creating Cool Slides With Emacs Org-Mode and Revealjs]]
- [[https://github.com/yjwen/org-reveal/][yjwen/org-reveal]]
- Finally I started from [[https://github.com/jlevallois/PhD-Thesis/tree/master/slides][jlevallois/PhD-Thesis]]
- Example of config : [[http://www.i3s.unice.fr/~malapert/org/tips/emacs_orgmode.html][Yet Another Org-Mode Configuration]]
- Example of slide html : https://privefl.github.io/thesis-docs/suivi-these.html#1

** Install local of reveal.js
  Install reaveal.js, see [[https://github.com/hakimel/reveal.js/#installation][reaveal.ls]] : 

#+BEGIN_SRC shell
    cd ~/Software/
    git clone https://github.com/hakimel/reveal.js.git
    cd reveal.js
    npm install
    npm start
#+END_SRC


** Beamer
see : [[http://orgmode.org/worg/exporters/beamer/tutorial.html][Writing Beamer presentations in org-mode]]

I use =org-beamer-mode= for shortcut.

* Introduction
:PROPERTIES:
:REVEAL_EXTRA_ATTR: slide-title="Introduction"
:END:
** La génomiques

#+ATTR_LATEX: :width nil :height 0.8\textheight
[[file:./img/costpergenome_2017.jpg]]

*** Notes                                                        :noexport:
Les dernière décéni ont été marquées par l'arrivé de sequenceur à haut débit à
permit de sequencer l'ADN de beaucoup d'oganisme vivant. Comment extraire de
l'information pour répondre au questions biologique.

https://www.genome.gov/sequencingcostsdata/

** Les données génétiques

- L'ADN peut être considéré comme une longue séquence des nucléotides : A, C, T, G. 

- On s'interesse au polymorphisme d'un seul nucléotide (SNPs)

On va plutot mettre https://fr.wikipedia.org/wiki/Polymorphisme_nucl%C3%A9otidique#/media/File:Dna-SNP.svg

#+BEGIN_EXPORT latex
\begin{figure}[!h]
  \centering
  ADNs \left \{\begin{tabular}{cccccccc}
                \cdots & G & A & \cellcolor{blue!25} T & C & C & \cdots & \cdots \\
                \cdots & G & A & \cellcolor{blue!25} A & C & C & \cdots & \cdots \\
                \cdots & G & A & \cellcolor{blue!25} A & C & C & \cdots & \cdots \\
                \cdots & G & A & \cellcolor{blue!25} T & C & C & \cdots & \cdots \\
                \cdots & G & A & \cellcolor{blue!25} T & C & C & \cdots & \cdots 
              \end{tabular}
              
              \caption{{\bf Illustration d'un SNP.} Le nucléotide différent
                entre les séquences est un SNP.}
\label{fig:SNP}
\end{figure}
#+END_EXPORT

** Les données génétiques

Les données sont rangé dans une matrice :

#+BEGIN_EXPORT latex
\begin{figure}[!h]
  \centering
$ \Y = 
\begin{bmatrix}
  0      & 1    &  2    & 2& \cdots      & \cdots & \cdots \\
  1      & 1    &  0    &1& \cdots      & \cdots    &  \cdots \\
  \vdots      & \vdots    &  \vdots    & \vdots     & \cdots   & \cdots    &  \cdots \\
  \vdots      & \vdots    &  \vdots    & \vdots     & \cdots   & \cdots    &  \cdots \\
  0      & 0    &  2    &0& \cdots      & \cdots    &  \cdots \\
\end{bmatrix}
$
\caption{{\bf Illustration d'une matrice de SNPs pour une espèce diploïde.}
  Chaque élément de la matrice est le nombre de fois que l'allèle muté est
  observé pour un individu donné à un locus donné.}
\label{fig:matrix}
\end{figure}
#+END_EXPORT

** Plan

- Inférence des coefficients de métissage à l'aide de données géographiques
  (=tess3r=)
  
- Algorithmes d'estimation pour les modèles de régression à facteurs latents (=lfmm=)

* Inférence des coefficients de métissage à l'aide de données géographiques
:PROPERTIES:
:REVEAL_EXTRA_ATTR: slide-title="Coefficient de métissage"
:END:
** La structure de population                                     :noexport:

- Les populations étudiées par la génétique des populations sont constituées d'un
  ensemble d'individus qui forme une unité de reproduction.

- Les individus d'une population peuvent se croiser entre eux, ils se reproduisent
  moins avec les individus des populations voisines, desquelles ils sont 
  géographiquement isolés.

** La structure génétiques des populations

#+NAME: code:diff
#+CAPTION: Dépend de [[file:~/Projects/Thesis/MaThese/main.org::code:tess3_intro_plot][code:tess3_intro_plot]] 
#+begin_src R 
  library(MaTheseR)
  library(scatterpie)
  library(ggplot2)
  MaTheseR.params <- get_MaTheseRparams()

  toplot <- readRDS("../OUTPUT/Expr/tess3_intro_freq_toplot_df.rds")
  expr <- readRDS("../OUTPUT/Expr/tess3_intro.rds")
  map.world <- ggmap::get_map(location = c(left = -140, bottom = -50, right = 100, top = 70),
                              maptype = "watercolor")

  pl <- ggmap(map.world) +
    MaTheseR.params$gtheme + 
    theme(panel.background = element_rect(fill = "transparent", colour = NA),
          plot.background = element_rect(fill = "transparent", colour = NA),
          legend.background = element_rect(fill = "transparent", colour = NA)) +
    coord_cartesian() + 
    geom_scatterpie(aes(x = lon, y = lat, r = r), data = toplot, cols = c("allèle 1", "allèle 2")) +
    guides(fill = guide_legend(title = paste0("SNP ", expr$snps.rs))) +
    scale_fill_manual(values = c("steelblue", "lightgreen")) +
    theme(legend.position="bottom") +
    xlab("Longitude") +
    ylab("Latitude") 

  ThesisRpackage::Plots_export_pdf(pl,
                                   basename.output = "tess3_intro_freq_slides",
                                   env = MaTheseR.params,
                                   height = 2.5,
                                   width = 4)
#+end_src

#+BEGIN_SRC shell
  cd ~/Projects/Thesis/MaThese/OUTPUT/Rplots/

  inkscape \
      --without-gui \
      --file=tess3_intro_freq_slides.pdf \
      --export-plain-svg=tess3_intro_freq_slides.png 
#+END_SRC

#+HTML: <div style="float:left;width:70%;margin-top:50px;">
#+LATEX: \begin{columns}
#+LATEX: \begin{column}{0.7\columnwidth}


#+CAPTION: *Différenciation allélique entre des populations.* Distribution des allèles du SNP rs17066888 dans des populations européenne, africaine et afro-américaine.
#+ATTR_HTML: :align center :style width:70%
[[file:../OUTPUT/Rplots/tess3_intro_freq_slides.svg]]

#+HTML: </div>
#+LATEX: \end{column}
#+LATEX: \begin{column}{0.3\columnwidth}
#+HTML: <div style="float:left;width:30%;margin-top:50px;">

Pressions évolutives :
- la mutation
- la sélection
- la dérive génétique
- la migration

#+HTML: </div>
#+LATEX: \end{column}
#+LATEX: \end{columns}

** Pourquoi étudier la structure génétiques des populations ?

- Représentation synthétique de données multivariées. 

- Étude de l'histoire démographique des populations citep:Li_2008.

- Facteur de correction dans les études d'association citep:marchini2004effects.

- Médecine personnalisé : calcul d'un score de risque génétique pour une maladie citep:Wray_2013.

- Étudier la répartition des populations dans leur habitat citep:Fran_ois_2015.

** Visualisation de la structure génétique des populations avec l'ACP

#+NAME: code:pca
#+CAPTION: Dépend de [[file:~/Projects/Thesis/MaThese/main.org::code:tess3_intro_plot][code:tess3_intro_plot]]
#+begin_src R 
  library(MaTheseR)
  library(ggplot2)
  MaTheseR.params <- get_MaTheseRparams()

  pl <- readRDS("../OUTPUT/Expr/tess3_intro_pca_toprint.rds") + 
    theme(legend.position = "right") +
    ylab("Composante\nprincipale 2") +
    theme(panel.background = element_rect(fill = "transparent", colour = NA),
          plot.background = element_rect(fill = "transparent", colour = NA),
          legend.box.background = element_rect(fill = "transparent", colour = NA),
          legend.background = element_rect(fill = "transparent", colour = NA))

  ThesisRpackage::Plots_export_tikz_pdf(pl,
                                        basename.output = "tess3_intro_pca_slides",
                                        env = MaTheseR.params,
                                        height = 2.5,
                                        width = 5)
#+END_SRC

#+BEGIN_SRC shell
  cd ~/Projects/Thesis/MaThese/OUTPUT/Rplots/

  inkscape \
      --without-gui \
      --file=tess3_intro_pca_slides.pdf \
      --export-plain-svg=tess3_intro_pca_slides.svg
#+END_SRC

#+CAPTION:Scores des deux premières composantes principales calculées sur des données de SNPs d'invidus humains de populations européenne, africaine et afro-américaine.
#+ATTR_HTML: :align center :style width:80%
[[file:../OUTPUT/Rplots/tess3_intro_pca_slides.svg]]

** Le modèle du logiciel =structure= citep:Pritchard2000

#+HTML: <div style="float:left;width:50%;margin-top:50px;">
#+LATEX: \begin{columns}
#+LATEX: \begin{column}{0.5\columnwidth}

#+BEGIN_EXPORT latex
\begin{figure}[th!]
\def\svgwidth{\linewidth}
\input{structure_inkscape.pdf_tex}
\caption{Illustration du modèle de structure génétique de population.}
\end{figure}
#+END_EXPORT

#+HTML: </div>
#+LATEX: \end{column}
#+LATEX: \begin{column}{0.5\columnwidth}
#+HTML: <div style="float:left;width:50%;margin-top:50px;">

\begin{equation*}
\Pr(\Y_{i,\ell} = j) = \sum_{k = 1}^{K} \matr{G}_{(d + 1)\ell + j, k} \Q_{i,k},
\end{equation*}
où 
- $\Pr(\Y_{i,\ell} = j)$ est la probabilité d'observer l'allèle $j$ au locus
  $\ell$ chez l'individu $i$
- $\matr{G}_{(d + 1)\ell + j, k}$ est la fréquence d'apparition de
  l'allèle $j$ au locus $\ell$ dans le groupe génétique $k$.
- $\matr{Q}_{i, k}$ est la proportion de gènes de l'individu $i$
  provenant du groupe $k$.

#+HTML: </div>
#+LATEX: \end{column}
#+LATEX: \end{columns}
** Méthodes d'estimation des coefficients de métissage

#+LATEX: \begingroup\small
#+LATEX: \rowcolors{2}{contiYellow!5}{contiYellow!20}
#+ATTR_LATEX: :align l|p{4cm}p{3cm}|p{3cm}
#+ATTR_HTML: :class TFtable
|---------------+-----------------------------------------+---------------------------------------------------+----------------------|
| Méthode       | Modèle                                  | Algorithme                                        | Référence            |
|---------------+-----------------------------------------+---------------------------------------------------+----------------------|
| STRUCTURE     | bayésien                                | MCMC                                              | citet:Pritchard2000  |
| FRAPPE        | vraisemblance                           | EM                                                | citet:Tang_2005      |
| ADMIXTURE     | vraisemblance                           | optimisation quasi-Newton alternée                | citet:Alexander_2011 |
| fastStructure | bayésien                                | inférence variationnelle bayésienne               | citet:Raj_2014       |
| PSIKO         | ACP                                     | SVD                                               | citet:Popescu_2014   |
| sNMF          | factorisation matricielle parcimonieuse | optimisation quadratique alternée avec projection | citet:Frichot_2014   |
#+LATEX:\rowcolors{2}{}{}
#+LATEX: \endgroup

** Visualisation des coefficients de métissage

#+NAME: code:pca
#+CAPTION: Dépend de [[file:~/Projects/Thesis/MaThese/main.org::code:tess3_intro_plot][code:tess3_intro_plot]]
#+begin_src R 
  library(MaTheseR)
  library(ggplot2)
  MaTheseR.params <- get_MaTheseRparams()

  pl <- readRDS("../OUTPUT/Expr/tess3_intro_barplot_toprint.rds")

  ThesisRpackage::Plots_export_pdf(pl,
                                   basename.output = "tess3_intro_barplot_slides",
                                   env = MaTheseR.params,
                                   height = 2,
                                   width = 5)
#+end_src

#+CAPTION: Estimation par le logiciel =snmf= citep:Frichot_2014 des coefficients de métissage pour un jeu de données composé d'individus humains provenant de populations européenne, africaine et afro-américaine.
[[file:../OUTPUT/Rplots/tess3_intro_barplot_slides.pdf]]

** Données géographiques

#+NAME: code:map
#+CAPTION: Dépend de rien
#+begin_src R 
  library(MaTheseR)
  library(tidyverse)
  library(ggmap)
  MaTheseR.params <- get_MaTheseRparams()
  gtheme <- MaTheseR.params$gtheme


  ## load coord
  ## data.file <- "../Data/AthalianaGegMapLines/call_method_75/call_method_75_TAIR9.RData"
  ## load(data.file)
  ## coord <- call_method_75_TAIR9.europe$coord
  ## rm(call_method_75_TAIR9.europe)
  ## saveRDS(coord, "../Data/AthalianaGegMapLines/call_method_75/call_method_75_TAIR9_coord.rds")
  ## gc()
  coord <- readRDS("../Data/AthalianaGegMapLines/call_method_75/call_method_75_TAIR9_coord.rds") 


  ## plot
  toplot <- as_tibble(coord)
  map.world <- ggmap::get_map(location =  c(left = -16, bottom = 42, right = 33, top = 67),
                              maptype = "watercolor")

  pl <- ggmap(map.world) +
    geom_point(data = toplot, mapping = aes(x = long, y = lat), color = "red", size = 0.25) +
    scale_size_continuous(guide = FALSE) +
    xlab("Longitude") +
    ylab("Latitude") +
    MaTheseR.params$gtheme


  save_expr(pl, "tess3_intro_map_slides_toplot.rds")
  ThesisRpackage::Plots_export_pdf(pl,
                                   basename.output = "tess3_intro_map_slides",
                                   env = MaTheseR.params,
                                   height = 3,
                                   width = 3)
#+end_src

#+ATTR_LATEX: :height 0.9\textheight :width nil
[[file:../OUTPUT/Rplots/tess3_intro_map_slides.pdf]]

** Méthodes d'estimation des coefficients de métissage à l'aide de données géographique

#+LATEX: \rowcolors[]{2}{contiYellow!5}{contiYellow!20}
#+ATTR_LATEX: :align l|p{4cm}p{3cm}|p{3cm}
|--------------+--------------------------------------------------+-----------------------------------+----------------------|
| Méthode      | Modèle                                           | Algorithme                        | Référence            |
|--------------+--------------------------------------------------+-----------------------------------+----------------------|
| TESS         | bayésien                                         | MCMC                              | citet:CHEN_2007      |
| GENELAND     | bayésien                                         | MCMC                              | citet:phdGuedj       |
| BAPS         | bayésien                                         | optimisation stochastique         | citet:Corander2008   |
| *TESS3-AQP*  | factorisation matricielle régularisée sur graphe | optimisation quadratique alternée |                      |
| *TESS3-APLS* | factorisation matricielle régularisée sur graphe | moindres carrés alternés projetés |                      |
| conStruct    | bayésien                                         | MCMC                              | citet:Bradburd189688 |
#+LATEX:\rowcolors{2}{}{}

** Estimation des matrices d'ascendance génétique

Ajouter un petit dessin de factorisation de matrice !!! se mettre sur 2 colonnes

citet:Frichot_2014 cherchent à décomposer la matrice de génotype :

\begin{equation*}
\Y = \Q \mathbf{G}^{T},
\end{equation*}

où

\begin{equation*}
\Q \geq 0 \, , \quad \sum_{k=1}^K {\bf Q}_{i,k} = 1, \quad i = 1...n
\end{equation*}

et

\begin{equation*}
\mathbf{G} \geq 0 \, , \quad \sum_{j=0}^{d} {\bf G}_{(d+1)\ell + j, k} = 1, \quad \ell = 1...p.
\end{equation*}

** Information géographique
*** graph
:PROPERTIES:
:BEAMER_col: 0.5
:END:

#+NAME: code:map_graph_print
#+CAPTION: Dépend de [[code:map]] [[code:map_graph]]
#+begin_src R 
  library(MaTheseR)
  library(tidyverse)
  library(ggmap)
  MaTheseR.params <- get_MaTheseRparams()
  gtheme <- MaTheseR.params$gtheme

  ## load coord
  coord <- readRDS("../Data/AthalianaGegMapLines/call_method_75/call_method_75_TAIR9_coord.rds") 

  ## graph.df <- readRDS("../OUTPUT/Expr/slide_graph_df.rds")
  graph.df <- tibble()
  long <- c(0,10,15,3,16,-3, 18)
  lat <- c(52,50,56,45,47,54,63)
  n <- length(lat)
  W.adj <- matrix(TRUE, n,n)
  for (i in 1:n) {
    graph.df <- graph.df %>%
      rbind(tibble(longend = long[W.adj[i,]], latend = lat[W.adj[i,]], long = long[i], lat = lat[i]))
  }

  ## plot
  pl <- readRDS("../OUTPUT/Expr/tess3_intro_map_slides_toplot.rds") +
    geom_segment(aes(x = long, y = lat, xend = longend, yend = latend),
                 color = "red",
                 data = graph.df)

  ThesisRpackage::Plots_export_pdf(pl,
                                   basename.output = "tess3_intro_map_graph_slides",
                                   env = MaTheseR.params,
                                   height = 3,
                                   width = 3)
#+end_src

[[file:../OUTPUT/Rplots/tess3_intro_map_graph_slides.pdf]]

**** Script                                                     :noexport:
#+NAME: code:map_graph
#+CAPTION: Dépend de rien
#+begin_src R :session *krakR* :results output :dir /scp:cayek@krakenator:~/Projects/Thesis/MaThese/
  library(MaTheseR)
  library(tidyverse)

  ## load coord
  coord <- readRDS("../Data/AthalianaGegMapLines/call_method_75/call_method_75_TAIR9_coord.rds")
  n <- nrow(coord)
  coord.smpl <- coord[sample(n, 300), ]
  n <- nrow(coord.smpl)

  ## graph
  library(tess3r)
  W <- tess3r::ComputeHeatKernelWeight(coord.smpl, 1.5)
  hist(W)
  W.adj <- matrix(FALSE, n, n)
  th2 <- 0.4
  th1 <- 0.1
  W.adj[th1 <= W & W <= th2] <- TRUE
  sum(W.adj)

  graph.df <- tibble()
  long <- coord.smpl[,"long"] %>% as.numeric()
  lat <- coord.smpl[,"lat"] %>% as.numeric()
  for (i in 1:n) {
    graph.df <- graph.df %>%
      rbind(tibble(longend = long[W.adj[i,]], latend = lat[W.adj[i,]], long = long[i], lat = lat[i]))
  }

  save_expr(graph.df, "slide_graph_df.rds")

  pl <- readRDS("./OUTPUT/Expr/tess3_intro_map_slides_toplot.rds")

  pl + geom_segment(aes(x = long, y = lat, xend = longend, yend = latend, colour = "segment"), data = graph.df)
#+end_src

*** formule
:PROPERTIES:
:BEAMER_col: 0.5
:END:

Entre chaque individu $i$ et $j$, nous avons le poids de graphe
\begin{equation*}
\W_{i,j} = \exp( - {\rm dist}( x_i, x_j )^2/ \sigma^2)
\end{equation*}

où la fonction ${\rm dist}( x_i, x_j)$ est une distance entre les coordonnées géographique $x_{i}$ et $x_{j}$. 

Ensuite, nous introduisons la régularisation
\begin{equation*}
\frac{1}{2} \sum_{i,j = 1}^n  \W_{i,j}  \| \Q_{i,.} - \Q_{j,.} \|^2
\end{equation*}

La régularisation peut se réécrire 
\begin{equation*}
{\rm Tr} (\Q^{T} \matr{\Gamma} \Q)
\end{equation*}

** Problème d'optimisation des moindres carrés

Pour estimer les matrice d'ascendance on cherche à optimiser la fonction 

\begin{equation*}
\mathcal{L}(\Q, \mathbf{G}) =   \|  {\bf Y} - {\bf QG}^T \|^2_{\rm F} +  \alpha {\rm Tr} (\Q^{T} \matr{\Gamma} \Q)
\end{equation*}

** Algorithme de descente par blocs de coordonnées
*** graphe
:PROPERTIES:
:BEAMER_col: 0.5
:END:
#+CAPTION: Illustration de l'algorithme de descente par blocs de coordonnées.
[[file:../OUTPUT/Rplots/coordinate_descente.pdf]]

*** test                                                            :BMCOL:
:PROPERTIES:
:BEAMER_col: 0.5
:END:

On alterne deux étapes jusque convergence vers un point critique : 

- optimisation de $\mathcal{L}$ selon $\Q$ avec $\matr{G}$ fixé
- optimisation de $\mathcal{L}$ selon $\matr{G}$ avec $\Q$ fixé

*Nous présentons deux algorithmes utilisant ce principe.*

** Algorithme d'optimisation quadratique alternée (AQP)           :noexport:

On alterne des optimisation de problème quadratiques 

- Calcul de $\matr{G}$ 
\begin{equation} 
\begin{aligned}
\mathbf{G} = \underset{g \in \DG}{\arg \min} ( -2  v^T_Q \, g + g^T \D_{Q} g ) ,
\label{eq:AQPg}
\end{aligned}
\end{equation}

- Calcul de $\Q$ 
\begin{equation} 
\begin{aligned}
\Q = \underset{q \in \DQ}{\arg \min} ( -2 v^T_G \, q + q^T \D_{G} q ) ,
\label{eq:AQPq}
\end{aligned}
\end{equation}

D'après citet:Grippo_2000, on a le théorème suivant

#+BEGIN_theorem
<<AQP_theorem>> L'algorithme AQP qui alterne les étapes d'optimisation des
problèmes eqref:eq:AQPg et eqref:eq:AQPq converge vers un minimum local de la
fonction $\LS$.
#+END_theorem

** Algorithme des moindres carrés alternés projetés (APLS)        :noexport:

On retire les contraintes des problèmes d'optimisations.

- Calcul de $\matr{G}$
\begin{equation*}
{\bf G} = \arg \min  \|  {\bf Y} - {\bf QG}^T \|^2_{\rm F} \, .
\end{equation*}
  projection de $\matr{G}$ sur $\DG$

- Calcul de $\Q$ 
  \begin{equation}
  \label{eq:tess3:apls:q}
  q_i^\star = \arg \min \| \mathcal{P}(\Y)_i - \mathbf{G} q \|^{2}_{2} + \alpha \lambda_i \| q \|^{2}_{2}  ,
  \end{equation}


  projection de $\matr{Q}$ sur $\DQ$

Il n'y a pas de résultats sur la convergence. *Mais* nous avons observé que APLS
fournis de bonnes approximation de AQP.

** Algorithme de descente par blocs de coordonnées
*** Algorithme d'optimisation quadratique alternée (AQP)

- D'après citet:Grippo_2000, AQP converge vers un minimum local de la fonction
  objectif $\LS$
- L'étape de calcul de $\Q$ implique de résoudre un problème d'optimisation
  convexe de taille $n \times K$

*** Algorithme des moindres carrés alternés projetés (APLS)

- L'étape de calcul de $\Q$ peut être séparé en $n$ moindres carré régularisé en
  norme $L_2$
- Il n'y a pas de garantit théorique sur la convergence
- Dans nos comparaisons, APLS fourni de bonnes approximations de AQP tout en
  étant plus rapide

*Nous utilisons APLS dans la suite*

** Simulation de génotypes métissés spatialement
*** graphe
:PROPERTIES:
:BEAMER_col: 0.5
:END:

#+BEGIN_EXPORT latex
\begin{figure}[th!]
\def\svgwidth{\linewidth}
\input{cline_inkscape.pdf_tex}
\end{figure}
#+END_EXPORT
*** texte                                                           :BMCOL:
:PROPERTIES:
:BEAMER_col: 0.5
:END:

- La matrice $\matr{G}$ est simulée par un modèle de Wright à deux îles
- La matrice $\Q$ est simulée selon un gradient longitudinal
- Ma matrice $\Y$ est générée en tirant des gènes des deux populations sources
  avec des probabilités données par les coefficient de métissage

On simule plusieurs génotype pour avoir plusieurs valeur de différenciation
mesuré par 
\begin{equation*}
F_{\rm ST} = \frac{1}{1 + 4N_0 m}
\end{equation*}

** Comparaison avec une méthode bayésienne TESS 2.3

#+BEGIN_EXPORT latex
\begin{figure}[!t]
\centering
\begin{minipage}{0.49\textwidth}
  \includegraphics[height=0.7\textheight]{../OUTPUT/Rplots/tess3_tess2_3_rmseG.pdf}
\end{minipage}
\begin {minipage}{0.49\textwidth}
  \includegraphics[height=0.7\textheight]{../OUTPUT/Rplots/tess3_tess2_3_rmseQ.pdf}
\end{minipage}
\caption{{\bf Racine de l'erreur quadratique moyenne (RMSE) pour l'estimation de
    $\Q$ (figure A) et $\mathbf{G}$ (figure B).}}
\end{figure}    
#+END_EXPORT
** Application à des données /Arabidopsis Thaliana/

On étudie 214k SNPs pour 1 095 écotypes européens des espèces végétales
/A.thaliana/ citep:Horton_2012.
*** fleur
:PROPERTIES:
:BEAMER_col: 0.5
:END:
#+ATTR_LATEX: :width nil :height 0.48\textheight
[[file:img/a_thaliana.jpg]]

*** carte                                                           :BMCOL:
:PROPERTIES:
:BEAMER_col: 0.5
:END:

[[file:../OUTPUT/Rplots/tess3_intro_map_slides.pdf]]

** Choix des paramètres

#+NAME: code:tess3_AT_params
#+CAPTION: Dépend de [[file:~/Projects/Thesis/MaThese/main.org::code:tess3_AT_params][code:tess3_AT_params]]
#+begin_src R :session *R* :dir ~/Projects/Thesis/MaThese/ :results silent
  library(MaTheseR)
  MaTheseR.params <- get_MaTheseRparams()

  pl <- readRDS("../OUTPUT/Expr/tess3_AT_params_plot.rds")

  ThesisRpackage::Plots_export_tikz_pdf(pl,
                                        basename.output = "tess3_AT_params_slides",
                                        env = MaTheseR.params,
                                        height = 3,
                                        width = 6.3)
#+end_src


#+CAPTION: Choix de $\sigma$ et $K$ pour l'algorithme APLS
[[file:../OUTPUT/Rplots/tess3_AT_params_slides.pdf]]

** Carte des coefficients de métissage

#+NAME: code:at_map_Q
#+CAPTION: Dépend de [[file:~/Projects/Thesis/MaThese/main.org::code:tess3_AT_map][code:tess3_AT_map]]
#+begin_src R 
  mappl <- readRDS("../OUTPUT/Expr/tess3_at_map.rds")

  ThesisRpackage::Plots_export_pdf(mappl,
                                   basename.output = "tess3_AT_map_slides",
                                   env = MaTheseR.params,
                                   height = 3,
                                   width = 5.2)
#+end_src

[[file:../OUTPUT/Rplots/tess3_AT_map_slides.pdf]]

* Algorithmes d'estimation pour les modèles de régression à facteurs latents
:PROPERTIES:
:REVEAL_EXTRA_ATTR: slide-title="Étude d'association"
:END:
** Test d'association

*Objectif*

Détecter les SNPs en relation avec une variable.

$$\Y \sim \X$$
Un petit dessin !!

*Exemple*

- Maladie  : diabète, maladie cœliaque
- Phénotype : la taille
- Environnement : la température

** Étude d'association entre des données génétiques et un gradient environnemental 

#+NAME: code:lfmm_map
#+CAPTION: Dépend de [[file:~/Projects/Thesis/MaThese/main.org::code:eas_climatic_gradient][code:eas_climatic_gradient]]
#+begin_src R 
  library(MaTheseR)
  library(ggmap)
  MaTheseR.params <- get_MaTheseRparams()


  indiv.df <- readRDS("../Data/ThesisDataset/3Article/1000GenomesPhase3/EAS_indiv_df_2.rds")

  map.world <- ggmap::get_map(location = c(left = -50, bottom = -50, right = 100, top = 70),
                              maptype = "watercolor")

  pl <- ggmap(map.world) +
    geom_point(data = indiv.df,
               mapping = aes(x = lon, y = lat, color = X),
               size = 1) +
    MaTheseR.params$gtheme +
    theme(panel.background = element_rect(fill = "transparent", colour = NA),
          plot.background = element_rect(fill = "transparent", colour = NA),
          legend.background = element_rect(fill = "transparent", colour = NA)) +
    scale_colour_gradient(low = "chartreuse1",
                        high = "firebrick1") + 
    xlab("Longitude") +
    ylab("Latitude")
  pl

  save_expr(pl, "lfmm_intro_map_covariate_slides_toplot.rds")

  ThesisRpackage::Plots_export_pdf(pl,
                                   basename.output = "lfmm_intro_map_covariate_slides",
                                   env = MaTheseR.params,
                                   height = 3,
                                   width = 3)
  ggsave("../OUTPUT/Rplots/lfmm_intro_map_covariate_slides.png",
         pl,
         width = 300 * 0.01041666666667,
         height = 200 * 0.01041666666667,
         dpi = 300,
         units = "in",
         bg = "transparent")
#+end_src

#+HTML: <div style="float:left;width:60%;margin-top:50px;">
#+LATEX: \begin{columns}
#+LATEX: \begin{column}{0.6\columnwidth}

[[file:~/Projects/Thesis/MaThese/OUTPUT/Rplots/lfmm_intro_map_covariate_slides.pdf]]
#+HTML: </div>
#+LATEX: \end{column}
#+LATEX: \begin{column}{0.4\columnwidth}
#+HTML: <div style="float:left;width:40%;margin-top:50px;">

Données génétiques du projet 1000Genome
- 1409 individus de 14 populations
- 5397214 locus

Gradient environnemental 
- données climatiques de la base WordClim
- première composante principale

#+HTML: </div>
#+LATEX: \end{column}
#+LATEX: \end{columns}

** Exemple d'une étude d'association avec les données /Arabidopsis Thaliana/ :noexport:
*** map                                                             :BMCOL:
:PROPERTIES:
:BEAMER_col: 0.5
:END:
#+NAME: code:AT_covariate_plot
#+CAPTION: Dépend de [[code:AT_covariate]]
#+begin_src R 
  library(MaTheseR)
  library(tidyverse)
  library(ggmap)
  library(broom)
  MaTheseR.params <- get_MaTheseRparams()
  gtheme <- MaTheseR.params$gtheme

  ## load data
  X <- readRDS("../Data/AthalianaGegMapLines/call_method_75/X_worldclim.rds")
  coord <- readRDS("../Data/AthalianaGegMapLines/call_method_75/call_method_75_TAIR9_coord.rds") 


  ## plot
  toplot <- coord %>%
    cbind(X = X) %>%
    as_tibble()
  map.world <- ggmap::get_map(location =  c(left = -16, bottom = 42, right = 33, top = 67),
                              maptype = "watercolor")

  cor(toplot)
  lm.df <- lm(X ~ lat + long - 1, data = toplot) %>%
    broom::tidy()
  lm.df


  pl <- ggmap(map.world) +
    geom_point(data = toplot, mapping = aes(x = long, y = lat, color = X), size = 0.25) +
    xlab("Longitude") +
    ylab("Latitude") +
    scale_colour_gradient(low = "chartreuse1",
                          high = "firebrick1") +
    MaTheseR.params$gtheme


  save_expr(pl, "tess3_intro_map_covariate_slides_toplot.rds")
  ThesisRpackage::Plots_export_pdf(pl,
                                   basename.output = "tess3_intro_map_covariate_slides",
                                   env = MaTheseR.params,
                                   height = 3,
                                   width = 3)
#+end_src

#+ATTR_LATEX: :height 0.9\textheight :width nil
[[file:~/Projects/Thesis/MaThese/OUTPUT/Rplots/tess3_intro_map_covariate_slides.pdf]]
*** text                                                            :BMCOL:
:PROPERTIES:
:BEAMER_col: 0.5
:END:

- On récupère des données climatiques à partir de la base données worldclim. 

- La covariable $\matr{X}$ est fabriquée en prenant la première composante
  principale de plusieur 

**** Scripts                                                    :noexport:
#+NAME: code:AT_covariate
#+CAPTION: Dépend de rien
#+begin_src R :session *krakR* :results output :dir /scp:cayek@krakenator:~/Projects/Thesis/MaThese/
  library(MaTheseR)

  ## load data
  data.file <- "./Data/AthalianaGegMapLines/call_method_75/call_method_75_TAIR9.RData"
  load(data.file)
  coord <- call_method_75_TAIR9.europe$coord
  rm(call_method_75_TAIR9.europe)
  gc()

  ## get climatic gradient
  ## worldclim : http://www.worldclim.org/formats1
  ## getdata in R: http://www.gis-blog.com/r-raster-data-acquisition/
  library(raster)
  climate <- raster::getData('worldclim', var='bio', res = 2.5)
  bio <- extract(climate, y = coord)
  pc.bio <- prcomp(bio,scale = T)
  plot(pc.bio$sdev)
  X <- pc.bio$x[,1]

  saveRDS(X, "./Data/AthalianaGegMapLines/call_method_75/X_worldclim.rds")

#+end_src

** Modèle de régression linéaire
Modèle linéaire pour chaque locus $\Y_{j}$
$$
\matr{Y}_{j} = \X \beta_{j} + \matr{E_{j}},
$$
où
- $\beta_j$ représente l'effet de la variable $\matr{X}$ sur le
- $\E_{j}$ est le bruit résiduel
On veux détecter les locus où l'on rejette l'hypothèse nulle
$$
H_0 : \beta_j = 0
$$
On réalise un *test de Student*
$$
t_j = \frac{\hat{\beta_j}}{\hat{\sigma}}
$$
où $\hat{\beta_j}$ et $\hat{\sigma}$ sont des estimations de l'effet et de son erreur standard.

** Étude d'association entre des données génétiques et un gradient environnemental

#+NAME: code:lfmm_qqplot
#+CAPTION: Dépend de 
#+begin_src R :session *krakR* :results output :dir /scp:cayek@krakenator:~/Projects/Thesis/MaThese/
  library(tidyverse)
  library(MaTheseR)
  library(cowplot)
  library(gridExtra)
  library(scales)
  MaTheseR.params <- get_MaTheseRparams()
  method.ordered <- MaTheseR.params$method.ordered
  color.values <- MaTheseR.params$color.values
  gtheme <- MaTheseR.params$gtheme

  ## res
  res.df <- readRDS("./OUTPUT/Expr/Eas_df_lm_2049b91fd6d2c9798533d7ebed94e547.rds")

  pl.qq <- ggplot(res.df, aes(sample = -log10(pvalue), color = method)) +
    stat_qq(distribution = stats::qexp, dparams = list(rate = log(10))) +
    geom_abline(slope = 1, intercept = 0) +
    scale_color_manual(name = "Méthodes", values = color.values) + 
    theme(legend.position = "none") +
    xlab("Quantiles théoriques") +
    ylab("Quantiles observés")

  ggsave("./OUTPUT/Rplots/lfmm_intro_lm_slide.png",
         pl.qq,
         width = 5.2,
         height = 3,
         dpi = 300,
         units = "in",
         bg = "transparent")
#+end_src

[[file:../OUTPUT/Rplots/lfmm_intro_lm_slide.png]]

** Modèles de régression à facteurs latents 

#+NAME: code:conf_factor
#+BEGIN_SRC dot :file img/conf_factor.png :exports results :eval no-export
  graph {
    graph [fontname = "serif"];
    node [fontname = "serif"];
    edge [fontname = "serif"];
    U -- Y;
    U -- X;
  }
#+END_SRC



#+HTML: <div style="float:left;width:50%;margin-top:50px;">
#+LATEX: \begin{columns}
#+LATEX: \begin{column}{0.5\columnwidth}

[[file:img/conf_factor.png]]

#+HTML: </div>
#+LATEX: \end{column}
#+LATEX: \begin{column}{0.5\columnwidth}
#+HTML: <div style="float:left;width:50%;margin-top:50px;">

\begin{equation}
\Y = \X \B^T + \matr{U} \V^T + \E.
\end{equation}

où 

- $\matr{U}$ est la matrices des variables latentes
- $\matr{V}$ est la matrices des effets des variables latentes
- $\B$ est l'effet de la variable $\matr{X}$ sur le
- $\E$ est la matrice de bruit résiduel

#+HTML: </div>
#+LATEX: \end{column}
#+LATEX: \end{columns}

** Méthodes d'estimation pour les modèles de régression à facteurs latents

#+LATEX: \begingroup\small
#+LATEX: \rowcolors[]{2}{contiYellow!5}{contiYellow!20}
#+ATTR_LATEX: :align p{2cm}|p{3.8cm}p{3.8cm}|p{2cm}
#+NAME: table:lfmm_etat_art
|-------------+-------------------------------------------------------+---------------------------------------------------------------------------------------+--------------------------------|
| Méthode     | Modèle                                                | Algorithme                                                                            | Référence                      |
|-------------+-------------------------------------------------------+---------------------------------------------------------------------------------------+--------------------------------|
| sva-twostep | ACP et régression linéaire                            | moindres carrés ordinaire et SVD                                                      | citet:article_Leek_Storey_2007 |
| sva-irw     | /weighted/-ACP et régression linéaire                 | moindres carrés ordinaire et /weighted/-SVD                                           | citet:article_Leek_Storey_2008 |
| cate        | analyse factorielle et régression linéaire            | EM ou SVD et estimation des moindres carrés généralisée                               | citet:wang2015confounder       |
| *ridgeLFMM* | factorisation matricielle avec régularisation $L_{2}$ | SVD et estimation des moindres carrés régularisée en norme $L_{2}$                    |                                |
| *lassoLFMM* | factorisation matricielle avec régularisation $L_{1}$ | /soft-thresholded/ SVD et estimation des moindres carrés régularisée en norme $L_{1}$ |                                |
#+LATEX:\rowcolors{2}{}{}
#+LATEX: \endgroup

** Estimateur des moindres carrées régularisé en norme L2
*Fonction objectif*

\begin{equation*}
\Lridge(\matr{U}, \V, \B) =  \frac{1}{2} \norm{\Y - \matr{U} \V^{T} - \X \B^T}_{F}^2 +
\frac{\lambRidge}{2} \norm{\B}^{2}_{2}%
\end{equation*}

*Algorithme*

1. On calcule
  $$
  \hat{\matr{U}} \hat{\V}^{T} & = \sqrt{\matr{P}_{\lambda}}^{-1} \svd_{\K}( \sqrt{\matr{P}_{\lambda}} \Y ) 
  $$
  où 
  $$
  \matr{P}_{\lambda} = \Id_{n} - (\X^T \X + \lambda \Id_{n})^{-1} \X^T \X
  $$

2. On calcule
  $$
  \hat{\B}^{T} & = (\X^{T} \X + \lambRidge \Id_{d})^{-1} \X^{T} (\Y - \hat{\matr{U}} \hat{\V}^{T}),
  $$

** Estimateur des moindres carrées régularisé en norme L2

*Si $\lambda \to 0$*
- \matr{P}_{\lambda} = \Id_{n} - (\X^T \X )^{-1} \X^T \X
- \matr{P}_{\lambda} n'est plus inversible
- $\U$ et $\V$ sont calculé sur le résidu de la régression linéaire de $\Y$ par $\X$
*Si $\lambda \to \infty$*
- \matr{P}_{\lambda} = \Id_{n}
- $\U$ et $\V$ sont données par l'ACP

*** Notes                                                        :noexport:

#+BEGIN_NOTES 
- si lambda -> 0
  on enlève complétement l'effet de X pour calculer les variables latentes.
  V est bien calculé (c'est l'approche de cate et sva-twostep)
  MAIS
  on ne peut plus inversé P pour calculer U
- si lambda -> inf
  on ne corrige pas le calculer des facteurs ===> on va capté un partie de ce
  qui doit être expliqué par X dans le calcul des facteurs !!
#+END_NOTES
** Estimateur des moindres carrées régularisé en norme L2

On peut montrer que

\begin{align*}
\Lridge(\matr{U}, \V, \B) & \geq & \Lridge(\matr{U}, \V, \hat{\B}) \\
 & & = \frac{1}{2} \norm{ \sqrt{\matr{P_{\lambda}}} (\Y - \matr{U} \V^{T})}_{F}^{2}
\end{align*}

*Théorème*

Pour $\lambRidge$ strictement supérieur à zéro, les estimateurs des paramètres
de LFMM régularisés en norme $L_{2}$ définissent un minimum global de la
fonction objectif $\Lridge$.

** Estimateur des moindres carrées régularisé en norme L1
*Fonction objectif*
\begin{equation*}
\Llasso(\W, \B) =  \frac{1}{2} \norm{\Y - \W - \X \B^T}_{F}^2 +
\lambLasso \norm{\B}_{1} + \gamma \norm{\W}_{*}
\end{equation*}

où $\matr{W}$ est la matrice latente et 
$$
\matr{W} = \matr{U} \matr{V}^T
$$
est calculé grâce à l'ACP.

** Estimateur des moindres carrées régularisé en norme L1

*Algorithme de descente par blocs de coordonnées*

On initialise 

\begin{align*}
\hat{\W}_{t = 0} & = 0 \\
\hat{\B}_{t = 0} & = 0
\end{align*}

On alterne les étapes:

1. Calculer $\hat{\B}_{t}$ le point minimum de 
   \begin{equation}
   \label{eq:lasso1}
   \mathcal{L}_{\mathrm{lasso}}^{'}(\B) =  \frac{1}{2} ||(\Y - \hat{\W}_{t-1}) - \X \B^T||_{F}^2 + \lambLasso ||\B||_1
   \end{equation}
2. Calculer $\hat{\W}_{t}$ le point minimum de  
   \begin{equation}
   \label{eq:lasso2}
   \mathcal{L}_{\mathrm{lasso}}^{''}(\W) = \frac{1}{2} ||(\Y - \X \hat{\B}_t^T)- \W ||_{F}^2 + \gamma ||\W||_{*}
   \end{equation}

** Estimateur des moindres carrées régularisé en norme L1

On a 
- $\W,\B \mapsto  \norm{\Y - \W - \X \B^T}_{F}^2$ est convexe et différentiable (terme d'attache au données dans $\Llasso$)
- $\B \mapsto \norm{\B}_{1}$ est continue et convexe
  (terme de régularisation dans $\Llasso$)
- $\W \mapsto \norm{\W}_{*}$ est continue et convexe
  (terme de régularisation dans $\Llasso$)

citet:Tseng_2001 ont montré que

*Théorème* 

L'algorithme d'estimation des moindres carré régularisé en norme $L_{1}$ converge
vers un minimum global de la fonction objectif $\Llasso$.

** Choix du nombre de variables latentes
On présente la procédure, c'est a dire transformation des données pour enlever
Y. (Méthode qui vient de cate, a vérifier mais je crois pas).

un scree plot a gauche et la formule a droite pour expliquer

*** Notes                                                        :noexport:
Une paramètre important dans les méthodes à facteur latent est le nombre de
variables latentes.

Comme ca je vais me préparer à la questions comment on choisi les autres.

** Tests d'hypothèse corrigés pour les facteurs de confusion

Pour chaque variable expliquée $\Y_{j}$
\begin{equation*}
\Y_{j} =  \hat{\matr{U}} \matr{\gamma}_{j}^{T} + \X \beta_{j} + \matr{E_{j}},
\end{equation*}
où $\hat{\matr{U}}$ est l'estimation de la matrice des variables latentes.

On test l'hypothèse
$$
H_0 : \beta_j = 0
$$
grâce à un *test de Student*.

*** Notes                                                        :noexport:
Jusqu'ici, nous avons abordé l'estimation des variables latentes et des effets.
Mais le but est de trouver les associations significatives ! On doit construire
un test de significativité qui prend en compte les facteurs que l'on a estimé.

** Contrôle du taux de Fausses Découvertes 

On cherche une liste de candidat $\Gamma = \{1,..,J\}$ tel que
$$p( \beta_j = 0 | j \in \Gamma) = T$$
où $T$ est le taux de fausse découverte souhaité.

On utilise la \qvalue de citet:Storey_2011 pour contrôler le taux de fausses
découvertes.

*** Notes                                                        :noexport:
Maintenant qu'on a des Pvalue on peut proposer une liste de découverte. On veut
fournir une liste de candidats

Remark : je parle pas de la calibration justement !!
Pour moi il y a deux choses le ranking et la calibration. citet:Sun_2012 en parle !!

** Données simulées                                               :noexport:
On calcule les $K$ premières composantes principales des chromosomes 1 et 2 de
la base de données 1000Genome (52211 SNPs et 1758 individus)
\begin{equation*}
\Y = \matr{U} \V^{T} + \E
\end{equation*}

On simule des variables latentes et une variable explicative
\begin{equation*}
\left[ \matr{U} \X \right] \sim \mathcal{N}(0, \matr{S}) \text{, avec } \matr{S} = 
\begin{bmatrix}
s_{1} & 0 & \cdots & \rho c_{1} \\
0 & \ddots & 0 & \vdots \\
\vdots & 0 & s_{K} & \rho c_{K} \\
\rho c_{1} & \cdots & \rho c_{K} & 1 \\
\end{bmatrix}
\end{equation*}
où $\rho$ est regle l'intessité de la corrélation entre $\matr{U}$ et $\X$.


Enfin
$$
\Y^{'} = \matr{U}^{'} \V^{T} + \X^{'} \B^{'}^{T} + \E
$$

** Données simulées à partir des données 1000Genomes
- On calcule les $K$ premières composantes principales des chromosomes 1 et 2 de
  la base de données 1000Genome (52211 SNPs et 1758 individus)
  \begin{equation*}
  \Y = \matr{U} \V^{T} + \E
  \end{equation*}

- On simule des variables latentes \matr{U}^{'} et une variable explicative
  $\X^{'}$ en contrôlant l'intessité de la corrélation.

- On simule $\B^{'}$ tel qu'une proportion soit non nulle. 

- On calcule une nouvelle matrice tel que
  $$
  \Y^{'} = \matr{U}^{'} \V^{T} + \X^{'} \B^{'}^{T} + \E
  $$

** Comparaison des méthodes sur des données simulées

On compare les méthodes : 
- lm
- lmPCA
- sva-twostep
- sva-irw
- cate
- oracle
- ridgeLFMM
- lassoLFMM

Critère
- AUC : aire sous la courbe 

mettre des images ??? oui comme en plus j'ai introduit le FDR c'est facile d'en
parler 

*** Notes                                                        :noexport:
On passe sous silence le facteur d'inflation !! On considère que tout le monde
est recalibré pour simplifier.
** Comparaison des méthodes sur des données simulées

#+NAME: code:lfmm_comp
#+CAPTION: Dépend de [[file:~/Projects/Thesis/MaThese/main.org::code:num_val_auc_gif_df][code:num_val_auc_gif_df]]
#+begin_src R 
  require(MaTheseR)
  MaTheseR.params <- get_MaTheseRparams()
  library(gridExtra)
  library(forcats)
  library(tidyverse)
  library(latex2exp)
  MaTheseR.params <- get_MaTheseRparams()
  method.ordered <- MaTheseR.params$method.ordered
  color.values <- MaTheseR.params$color.values
  gtheme <- MaTheseR.params$gtheme

  auc.df <- readRDS("../OUTPUT/Expr/auc.df.rds") 

  ## filter and order method
  auc.df <- auc.df %>%
    dplyr::mutate(method = factor(article3_method_name(method), method.ordered))
  auc.df$method %>% unique()

  ## auc
  toplot <- auc.df %>%
    group_by(method, rho.c) %>%
    summarise(auc.mean = mean(auc), N = length(auc), sd = sd(auc), se = sd / sqrt(N))
  auc.rho.pl <- ggplot(toplot, aes(x = as.factor(rho.c), y = auc.mean, fill = method)) +
    geom_bar(position = "dodge", stat = "identity") +
    geom_errorbar(aes(ymin = auc.mean - se,
                      ymax = auc.mean + se),
                  width = 0.9,
                  position = "dodge") +
    scale_fill_manual(values = color.values) +
    gtheme + 
    theme(legend.position = "bottom") +
    xlab("Param\\`etre de corr\\'elation entre $\\mathbf{U}$ et $\\mathbf{X}$ ($\\rho$)") +
    ylab("AUC")

  ThesisRpackage::Plots_export_tikz_pdf(auc.rho.pl,
                                        basename.output = "lfmm_method_comp_slides",
                                        env = MaTheseR.params,
                                        width = 5.2,
                                        height = 3)
#+end_src


Enlever 0.1 et 0.3 (les cas interessant)

[[file:../OUTPUT/Rplots/lfmm_method_comp_slides.pdf]]

** Étude d'association entre des données génétiques et un gradient environnemental

#+NAME: code:lfmm_geas_scree
#+CAPTION: Dépend de [[file:~/Projects/Thesis/MaThese/main.org::code:eas_screeplot_CV][code:eas_screeplot_CV]]
#+begin_src R 
  library(MaTheseR)
  library(cowplot)
  library(scales)
  MaTheseR.params <- get_MaTheseRparams()

  latex_percent <- function (x) {
    x <- plyr::round_any(x, scales:::precision(x)/100)
    stringr::str_c(comma(x * 100), "\\%")
  }

  ## screeplot
  expr <- readRDS("../OUTPUT/Expr/geas_screeplot_expr.rds")
  plA <- ggplot(expr, aes(x = index, y = var.expl)) +
    geom_point() +
    coord_cartesian(xlim = c(1,15)) +
    xlab("Nombre de variables latentes ($K$)") +
    ylab("Variance\nexpliqu\\'ee") +
    MaTheseR.params$gtheme +
    scale_color_discrete(name = "$\\lambda$") +
    scale_y_continuous(labels=latex_percent) +
    geom_vline(xintercept = 9, linetype = "dashed") +
    theme(legend.position=c(0.8, 0.6))

  ThesisRpackage::Plots_export_tikz_pdf(plA,
                                        basename.output = "lfmm_geas_scree_slide",
                                        env = MaTheseR.params,
                                        height = 3,
                                        width = 5.2)
#+end_src


[[file:../OUTPUT/Rplots/lfmm_geas_scree_slide.pdf]]

*** Notes                                                        :noexport:
Retour sur l'exemple
** Étude d'association entre des données génétiques et un gradient environnemental

#+NAME: code:lfmm_geas_PCs_slide
#+CAPTION: Dépend de [[file:~/Projects/Thesis/MaThese/main.org::code:eas_PCs][code:eas_PCs]]
#+begin_src R 
  library(MaTheseR)
  MaTheseR.params <- get_MaTheseRparams()

  pl.leg <- readRDS("../OUTPUT/Expr/eas_pc_toprint.rds")

  pl <- pl.leg$pl
  mylegend <- pl.leg$mylegend

  pl.leg <- drawable(function() {
    gridExtra::grid.arrange(pl,
                            mylegend, nrow=2, heights=c(10, 2))
  })


  ThesisRpackage::Plots_export_tikz_pdf(pl.leg,
                                        basename.output = "lfmm_geas_pc_slides",
                                        env = MaTheseR.params,
                                        height = 5,
                                        width = 7.2)
#+end_src

[[file:../OUTPUT/Rplots/lfmm_geas_pc_slides.pdf]]

*** Notes                                                        :noexport:
les plots en étoiles
Enlever les lettres !!

** Étude d'association entre des données génétiques et un gradient environnemental

#+BEGIN_EXPORT latex
\begin{figure}[!h]
\centering
\includegraphics[height=0.6\textheight]{../OUTPUT/Rplots/geas_venn.png}
\caption{{\bf Diagramme de Venn de l'étude d'association entre des génotypes et
    un gradient environnemental (GEAS).} Diagramme de Venn des listes controlées à
  un taux de fausses de découvertes de $1 \%$ pour chaque méthode.}
\label{fig:geas_venn}
\end{figure}
#+END_EXPORT

*** Notes                                                        :noexport:
Dire pk il reste seulement ces méthodes
diagramme de venne : montre que tout le monde ne fait pas pareil
Les candidats détecté par lassoLFMM, ridgeLFMM et cate 
** Étude d'association entre des données génétiques et un gradient environnemental

#+LATEX: \rowcolors{2}{gray!25}{white}
#+NAME: code:geas_table_print
#+CAPTION: Dépend de [[file:~/Projects/Thesis/MaThese/main.org::code:geas_table][code:geas_table]]
#+begin_src R :results output latex replace :exports results :session *R* :dir ~/Projects/Thesis/MaThese/
  library(xtable)
  library(knitr)
  library(kableExtra)

  table.df <- readRDS("../OUTPUT/Expr/geas_table_toprint.rds")

  ## table.df %>% names() %>% paste0(collapse = "|")

  table.df %>%
    xtable(align = "lp{4cm}ll", type = "latex", label = "table:geas",
           caption = "{\\bf SNPs associés avec un gradient climatique qui ont été associés avec des phénotypes dans d'autres études.} SNPs présents dans l'union des SNPs détectés par les méthodes lassoLFMM, ridgeLFMM, cate et PCAlm pour un le FDR à $1\\%$.") %>%
    print(include.rownames=FALSE,
          sanitize.colnames.function=identity,
          sanitize.text.function=identity,
          floating = TRUE
          )
#+end_src

#+RESULTS: code:geas_table_print
#+BEGIN_EXPORT latex
% latex table generated in R 3.4.0 by xtable 1.8-2 package
% Tue Nov 14 15:53:24 2017
\begin{table}[ht]
\centering
\begin{tabular}{p{4cm}ll}
  \hline
SNPs & Détecté par les méthodes & Description du phénotype \\ 
  \hline
rs10908907 & ridgeLFMM, cate & Alcoholism (heaviness of drinking) \\ 
  rs10496731 & lassoLFMM & Body Height \\ 
  rs2472297 & ridgeLFMM, cate, lassoLFMM & Caffeine metabolism \\ 
  rs2256175 & ridgeLFMM, cate, lassoLFMM & Cholesterol total \\ 
  rs2472297 & ridgeLFMM, cate, lassoLFMM & Coffee consumption (cups per day) \\ 
  rs2278544, rs2322659 & lassoLFMM & Congenital lactase deficiency \\ 
  rs4954218 & ridgeLFMM, cate, lassoLFMM & Corneal structure \\ 
  rs882300 & ridgeLFMM, cate, lassoLFMM & Electrocardiographic traits \\ 
  rs882300 & ridgeLFMM, cate, lassoLFMM & Electrocardiography \\ 
  rs2256175 & ridgeLFMM, cate, lassoLFMM & Giant cell arteritis \\ 
  rs2256175, rs6085576, rs2104012, rs1983716, rs2853977 & ridgeLFMM, cate, lassoLFMM & Height \\ 
  rs6430549 & ridgeLFMM, cate, lassoLFMM & Hematocrit \\ 
  rs2278544, rs2322659 & lassoLFMM & Lactose intolerance \\ 
  rs882300 & ridgeLFMM, cate, lassoLFMM & Multiple sclerosis \\ 
  rs1123848 & ridgeLFMM, cate, lassoLFMM & Neuroblastoma \\ 
  rs17158483 & lassoLFMM & Obesity-related traits \\ 
   \hline
\end{tabular}
\caption{{\bf SNPs associés avec un gradient climatique qui ont été associés avec des phénotypes dans d'autres études.} SNPs présents dans l'union des SNPs détectés par les méthodes lassoLFMM, ridgeLFMM, cate et PCAlm pour un le FDR à $1\%$.} 
\label{table:geas}
\end{table}
#+END_EXPORT

#+LATEX:\rowcolors{2}{}{}

** Étude d'association entre des niveaux de méthylation de l'ADN et la polyarthrite rhumatoïde (EWAS)
:LOGBOOK:
- Note taken on [2017-11-14 mar. 16:13] \\
  Sources: 
  - image from https://en.wikipedia.org/wiki/DNA_methylation
:END:

#+HTML: <div style="float:left;width:40%;margin-top:50px;">
#+LATEX: \begin{columns}
#+LATEX: \begin{column}{0.4\columnwidth}

#+ATTR_LATEX: :width \textwidth :height nil
[[file:./img/1280px-DNA_methylation.jpg]]

#+HTML: </div>
#+LATEX: \end{column}
#+LATEX: \begin{column}{0.6\columnwidth}
#+HTML: <div style="float:left;width:60%;margin-top:50px;">

*Données*

- $\Y$ contient le niveau de méthylation de $485 577$ sites de l'ADN chez 699
  individus
- $\X$ contient la maladie polyarthrite rhumatoïde

*Facteurs de confusion*

- âge
- genre
- consommation de tabac

*Objectif*

Trouver les sites de méthylation associés à la maladie polyarthrite rhumatoïde.

#+HTML: </div>
#+LATEX: \end{column}
#+LATEX: \end{columns}

*** Notes                                                        :noexport:
La méthylation de l'ADN est un processus au cours duquel un groupe méthyle est
ajouté aux molécules d'ADN. La méthylation peut changer l'activité de l'ADN et
en particulier modifier sa transcription en protéine.

** Étude d'association entre des niveaux de méthylation de l'ADN et la polyarthrite rhumatoïde (EWAS)
#+BEGIN_EXPORT latex
\begin{figure}[!h]
\centering
\includegraphics[height=0.6\textheight]{../OUTPUT/Rplots/ewas_venn.png}
\caption{{\bf Diagramme de Venn de l'étude d'association entre des sites de
    méthylation et la polyarthrite rhumatoïde (EWAS).} Diagramme de Venn des
  listes controlées à un taux de fausses de découvertes de 1 \%.}
\label{fig:ewas_venn}
\end{figure}
#+END_EXPORT
** Étude d'association entre des niveaux de méthylation de l'ADN et la polyarthrite rhumatoïde (EWAS)
#+LATEX: \rowcolors{2}{gray!25}{white}
#+NAME: code:ewas_table_print
#+CAPTION: Dépend de [[file:~/Projects/Thesis/MaThese/main.org::code:ewas_table][code:ewas_table]] 
#+begin_src R :results output latex replace :exports results :session *R* :dir ~/Projects/Thesis/MaThese/
  library(xtable) ## https://cran.r-project.org/web/packages/xtable/vignettes/xtableGallery.pdf

  ewas.table <- readRDS("../OUTPUT/Expr/ewas_table_toprint.rds")

  ewas.table %>%
    xtable(align = "lllllcccc",
           digits = -2, type = "latex",
           caption = "{\\bf Sites de méthylation associés avec la maladie polyarthrite rhumatoïde (EWAS).} \\pvalues des candidats détectés par les méthodes PCAlm, lassoLFMM, ridgeLFMM et cate pour un taux de fausse décourverte controlé à 1$\\%$ pour l'EWAS. Les Sites de méthylation en gras sont les candidats de \\citep{Zou_2014, Rahmani_2016}",
           label = "table:ewas") %>%
    print(include.rownames=FALSE,
          sanitize.text.function=identity)

#+end_src

#+RESULTS: code:ewas_table_print
#+BEGIN_EXPORT latex
% latex table generated in R 3.4.0 by xtable 1.8-2 package
% Tue Nov 14 16:28:21 2017
\begin{table}[ht]
\centering
\begin{tabular}{llllcccc}
  \hline
ID & Chr & Position & Gene & PCAlm & lassoLFMM & cate & ridgeLFMM \\ 
  \hline
\textbf{cg16411857} & \textbf{16} & \textbf{57023191} & \textbf{NLRC5} & \textbf{9.2e-13} & \textbf{2.4e-12} & \textbf{6.6e-12} & \textbf{5.3e-12} \\ 
  \textbf{cg07839457} & \textbf{16} & \textbf{57023022} & \textbf{NLRC5} & \textbf{1.9e-11} & \textbf{4.5e-11} & \textbf{1.1e-10} & \textbf{9.7e-11} \\ 
  \textbf{cg05428452} & \textbf{6} & \textbf{32712979} & \textbf{HLA-DQA2} & \textbf{5.4e-11} & \textbf{4.6e-11} & \textbf{8.5e-11} & \textbf{8.8e-11} \\ 
  cg02508743 & 8 & 56903623 & LYN & 2.9e-08 & 2.7e-08 & 2.7e-08 & 2.8e-08 \\ 
  \textbf{cg20821042} & \textbf{6} & \textbf{32709158} & \textbf{HLA-DQA2} & \textbf{6.5e-08} & \textbf{6.1e-08} & \textbf{9.6e-08} & \textbf{1.0e-07} \\ 
  cg13081526 & 6 & 32449961 &  & 1.5e-07 & 1.2e-07 & 2.0e-07 & 2.2e-07 \\ 
  cg18052547 & 6 & 32552547 & HLA-DRB1 & 1.8e-07 & 1.8e-07 & 3.0e-07 & 3.1e-07 \\ 
  \textbf{cg25372449} & \textbf{6} & \textbf{32490350} & \textbf{HLA-DRB5} & \textbf{2.5e-07} & \textbf{2.6e-07} & \textbf{4.5e-07} & \textbf{4.6e-07} \\ 
  cg02030958 & 13 & 110386267 &  & 4.0e-07 & 7.8e-08 & 6.0e-08 & 1.1e-07 \\ 
  cg16171858 & 3 & 58472734 &  & 4.6e-07 & 1.6e-07 & 2.7e-08 & 3.8e-08 \\ 
  cg03280622 & 8 & 145023013 & PLEC1 & 4.7e-07 & 5.0e-09 & 5.8e-09 & 3.8e-08 \\ 
  cg24150157 & 19 & 51891210 & LIM2 & 6.2e-07 & 3.1e-07 & 1.6e-07 & 2.1e-07 \\ 
  cg26244575 & 12 & 76354015 &  & 6.9e-07 & 2.7e-09 & 5.0e-10 & 4.2e-09 \\ 
  cg05370853 & 6 & 32606634 & HLA-DQA1 & 7.1e-07 & 3.0e-07 & 3.3e-07 & 4.4e-07 \\ 
  cg14989316 & 10 & 80757927 & LOC283050 & 7.3e-07 & 6.1e-08 & 7.8e-08 & 2.1e-07 \\ 
  cg17360552 & 6 & 32725332 & HLA-DQB2 & 8.1e-07 & 6.1e-07 & 1.1e-06 & 1.2e-06 \\ 
  cg01373248 & 3 & 18480297 & SATB1 & 8.1e-07 & 1.4e-07 & 1.1e-07 & 2.5e-07 \\ 
  cg26164488 & 2 & 64440295 &  & 9.3e-07 & 3.5e-09 & 1.6e-09 & 1.4e-08 \\ 
  cg05874806 & 2 & 102350276 & MAP4K4 & 1.1e-06 & 1.1e-06 & 4.7e-07 & 5.6e-07 \\ 
   \hline
\end{tabular}
\caption{{\bf Sites de méthylation associés avec la maladie polyarthrite rhumatoïde (EWAS).} \pvalues des candidats détectés par les méthodes PCAlm, lassoLFMM, ridgeLFMM et cate pour un taux de fausse décourverte controlé à 1$\%$ pour l'EWAS. Les Sites de méthylation en gras sont les candidats de \citep{Zou_2014, Rahmani_2016}} 
\label{table:ewas}
\end{table}
#+END_EXPORT


#+LATEX:\rowcolors{2}{}{}

* Conclusions
:PROPERTIES:
:REVEAL_EXTRA_ATTR: slide-title="Conclusions et perspectives"
:END:
** Deux logiciels                                                 :noexport:
tess3r et lfmm
de la factorisation de matrices
** =tess3r=

- Package R
#+begin_src R :exports both
  # install.packages("devtools")
  devtools::install_github("bcm-uga/TESS3_encho_sen")
#+end_src
- Nouveau modèle pour l'estimation de la structure génétique des populations à
  partir de données génétique et géographique
- Deux algorithmes pour l'inférence des paramètres
- Même precision statistique que le logiciel bayesien  =TESS= 2.3 
- Algorithme 30 fois plus rapide que =TESS= 2.3
- Visualisation de la strucuture génétique de population dans l'espace

** =lfmm=

- Package R
#+begin_src R :exports both
  # install.packages("devtools")
  devtools::install_github("bcm-uga/lfmm")
#+end_src
- Deux nouveaux algorithmes d'estimation pour les modèles de régression à facteur
  latents
- Résultats théorique sur la convergence des algorithmes
- Sur les simulations même puissance que l'oracle et que la méthode cate
- Sur des données réelles les méthodes reposant sur le modèle de regression à
  facteurs latents découvre plus d'association.
- Sur les données réelles les associassions découvertes peuvent varier largement
  entre les méthodes

** perspectives                                                   :noexport:
- perspective de maintient des logiciel 
- utilisation d'approche basé sur la factorisation matriciel à d'autre étude, 
ex RNA-Seq et données méthylation au débit => s'attendre a des questions
* Merci de votre attention
* Bibliography
bibliography:../biblio.bib
