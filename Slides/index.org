# -*- coding: utf-8 -*-
# -*- mode: org -*-

# beamer
#+startup: beamer
#+LaTeX_CLASS: beamer
#+LaTeX_CLASS_OPTIONS: [aspectratio=169, xcolor={table}]
#+BEAMER_FRAME_LEVEL: 2
#+OPTIONS: H:2 toc:nil num:nil
#+latex_header: \usepackage[citestyle=authoryear, bibstyle=authoryear, hyperref=true,backref=true,maxcitenames=2,url=true,backend=biber,natbib=true]{biblatex}
#+latex_header: \addbibresource{../biblio.bib}
#+LATEX_HEADER: \input{../packages.tex}
#+LATEX_HEADER: \input{../setup.tex}
#+LATEX_HEADER: \input{../notations.tex}


#+TITLE: Méthodes de factorisation matricielle pour la génomique des populations et les tests d'association
#+AUTHOR: Kévin CAYE
#+LANGUAGE: fr
#+STARTUP: overview indent inlineimages logdrawer
#+TAGS: noexport(n)
#+EXPORT_SELECT_TAGS: export
#+EXPORT_EXCLUDE_TAGS: noexport
#+COLUMNS: %25ITEM %TODO %3PRIORITY %TAGS
#+SEQ_TODO: TODO(t!) STARTED(s!) WAITING(w!) RUNNING(r!) DEBUG(g!) APPT(a!) | DONE(d!) CANCELLED(c!) DEFERRED(f!)

# reveal
#+REVEAL_ROOT: ./
#+REVEAL_TRANS: none
#+OPTIONS: reveal_mathjax:t reveal_slide_number:h.v/t reveal_history:t
#+OPTIONS: reveal_title_slide:nil reveal_center:nil
#+OPTIONS: reveal_width:1200 reveal_height:800
#+REVEAL_THEME: cayek_solarized
#+REVEAL_HLEVEL: 0 ## all header on same lvl
#+REVEAL_SPEED: fast
#+REVEAL_EXTRA_CSS: ./local.css

#+PROPERTY: header-args :exports none :eval no-export :session *R* :dir ~/Projects/Thesis/MaThese/Slides :results silent

# title
#+BEGIN_EXPORT html
<section>
	<h1 style="-webkit-hyphens:none;-moz-hyphens:none;hyphens:none;"> <strong>Méthodes de
	factorisation matricielle pour la génomique des populations et les tests
	d'association</strong><br/>
	<h3 style="margin-top:50px;">Kévin CAYE</h3>
	<footer>
		<div>
			Thèse dirigée par Olivier FRANÇOIS <br/>
      et co-encadrée par Olivier MICHEL et Jean-Luc BOSSON
		</div>
	  <img src="img/logo/logo-comue.png" class="ugaLogo"/>
	</footer>
	<aside class="notes">
    Intro
  </aside>
</section>
#+END_EXPORT

* Install                                                          :noexport:
Install with spacemacs see [[https://github.com/syl20bnr/spacemacs/tree/master/layers/%252Bemacs/org#revealjs-support][Reveal.js support]].
Some sources: 
- [[http://jr0cket.co.uk/2013/10/create-cool-slides--Org-mode-Revealjs.html.html][Creating Cool Slides With Emacs Org-Mode and Revealjs]]
- [[https://github.com/yjwen/org-reveal/][yjwen/org-reveal]]
- Finally I started from [[https://github.com/jlevallois/PhD-Thesis/tree/master/slides][jlevallois/PhD-Thesis]]
- Example of config : [[http://www.i3s.unice.fr/~malapert/org/tips/emacs_orgmode.html][Yet Another Org-Mode Configuration]]
- Example of slide html : https://privefl.github.io/thesis-docs/suivi-these.html#1

** Install local of reveal.js
  Install reaveal.js, see [[https://github.com/hakimel/reveal.js/#installation][reaveal.ls]] : 

#+BEGIN_SRC shell
    cd ~/Software/
    git clone https://github.com/hakimel/reveal.js.git
    cd reveal.js
    npm install
    npm start
#+END_SRC


** Beamer
see : [[http://orgmode.org/worg/exporters/beamer/tutorial.html][Writing Beamer presentations in org-mode]]

I use =org-beamer-mode= for shortcut.

* Introduction
:PROPERTIES:
:REVEAL_EXTRA_ATTR: slide-title="Introduction"
:END:
** La génomiques
 
une image d'adn 

en fond ??? un truc avec plien d'ACTG

Les dernière décéni ont été marquées par l'arrivé de sequenceur à haut débit. 

Une photo de "il y a beaucoup de données"

** Les données génétiques


- L'ADN peut être considéré comme une longue séquence des nucléotides : A, C, T, G. 

- On s'interesse au polymorphisme d'un seul nucléotide (SNPs)

On va plutot mettre https://fr.wikipedia.org/wiki/Polymorphisme_nucl%C3%A9otidique#/media/File:Dna-SNP.svg

#+BEGIN_EXPORT latex
\begin{figure}[!h]
  \centering
  ADNs \left \{\begin{tabular}{cccccccc}
                \cdots & G & A & \cellcolor{blue!25} T & C & C & \cdots & \cdots \\
                \cdots & G & A & \cellcolor{blue!25} A & C & C & \cdots & \cdots \\
                \cdots & G & A & \cellcolor{blue!25} A & C & C & \cdots & \cdots \\
                \cdots & G & A & \cellcolor{blue!25} T & C & C & \cdots & \cdots \\
                \cdots & G & A & \cellcolor{blue!25} T & C & C & \cdots & \cdots 
              \end{tabular}
              
              \caption{{\bf Illustration d'un SNP.} Le nucléotide différent
                entre les séquences est un SNP.}
\label{fig:SNP}
\end{figure}
#+END_EXPORT

** Les données génétiques

Les données sont rangé dans une matrice :

#+BEGIN_EXPORT latex
\begin{figure}[!h]
  \centering
$ \Y = 
\begin{bmatrix}
  0      & 1    &  2    & 2& \cdots      & \cdots & \cdots \\
  1      & 1    &  0    &1& \cdots      & \cdots    &  \cdots \\
  \vdots      & \vdots    &  \vdots    & \vdots     & \cdots   & \cdots    &  \cdots \\
  \vdots      & \vdots    &  \vdots    & \vdots     & \cdots   & \cdots    &  \cdots \\
  0      & 0    &  2    &0& \cdots      & \cdots    &  \cdots \\
\end{bmatrix}
$
\caption{{\bf Illustration d'une matrice de SNPs pour une espèce diploïde.}
  Chaque élément de la matrice est le nombre de fois que l'allèle muté est
  observé pour un individu donné à un locus donné.}
\label{fig:matrix}
\end{figure}
#+END_EXPORT

** Plan

- Inférence des coefficients de métissage à l'aide de données géographiques
  (=tess3r=)
  
- Algorithmes d'estimation pour les modèles de régression à facteurs latents (=lfmm=)

* Inférence des coefficients de métissage à l'aide de données géographiques
:PROPERTIES:
:REVEAL_EXTRA_ATTR: slide-title="Coefficient de métissage"
:END:
** La structure de population                                     :noexport:

- Les populations étudiées par la génétique des populations sont constituées d'un
  ensemble d'individus qui forme une unité de reproduction.

- Les individus d'une population peuvent se croiser entre eux, ils se reproduisent
  moins avec les individus des populations voisines, desquelles ils sont 
  géographiquement isolés.

** La structure génétiques des populations

#+NAME: code:diff
#+CAPTION: Dépend de [[file:~/Projects/Thesis/MaThese/main.org::code:tess3_intro_plot][code:tess3_intro_plot]] 
#+begin_src R 
  library(MaTheseR)
  library(scatterpie)
  library(ggplot2)
  MaTheseR.params <- get_MaTheseRparams()

  toplot <- readRDS("../OUTPUT/Expr/tess3_intro_freq_toplot_df.rds")
  expr <- readRDS("../OUTPUT/Expr/tess3_intro.rds")
  map.world <- ggmap::get_map(location = c(left = -140, bottom = -50, right = 100, top = 70),
                              maptype = "watercolor")

  pl <- ggmap(map.world) +
    MaTheseR.params$gtheme + 
    theme(panel.background = element_rect(fill = "transparent", colour = NA),
          plot.background = element_rect(fill = "transparent", colour = NA),
          legend.background = element_rect(fill = "transparent", colour = NA)) +
    coord_cartesian() + 
    geom_scatterpie(aes(x = lon, y = lat, r = r), data = toplot, cols = c("allèle 1", "allèle 2")) +
    guides(fill = guide_legend(title = paste0("SNP ", expr$snps.rs))) +
    scale_fill_manual(values = c("steelblue", "lightgreen")) +
    theme(legend.position="bottom") +
    xlab("Longitude") +
    ylab("Latitude") 

  ThesisRpackage::Plots_export_pdf(pl,
                                   basename.output = "tess3_intro_freq_slides",
                                   env = MaTheseR.params,
                                   height = 2.5,
                                   width = 4)
#+end_src

#+BEGIN_SRC shell
  cd ~/Projects/Thesis/MaThese/OUTPUT/Rplots/

  inkscape \
      --without-gui \
      --file=tess3_intro_freq_slides.pdf \
      --export-plain-svg=tess3_intro_freq_slides.png 
#+END_SRC

#+HTML: <div style="float:left;width:70%;margin-top:50px;">
#+LATEX: \begin{columns}
#+LATEX: \begin{column}{0.7\columnwidth}


#+CAPTION: *Différenciation allélique entre des populations.* Distribution des allèles du SNP rs17066888 dans des populations européenne, africaine et afro-américaine.
#+ATTR_HTML: :align center :style width:70%
[[file:../OUTPUT/Rplots/tess3_intro_freq_slides.svg]]

#+HTML: </div>
#+LATEX: \end{column}
#+LATEX: \begin{column}{0.3\columnwidth}
#+HTML: <div style="float:left;width:30%;margin-top:50px;">

Pressions évolutives :
- la mutation
- la sélection
- la dérive génétique
- la migration

#+HTML: </div>
#+LATEX: \end{column}
#+LATEX: \end{columns}

** Pourquoi étudier la structure génétiques des populations ?

- Représentation synthétique de données multivariées. 

- Étude de l'histoire démographique des populations citep:Li_2008.

- Facteur de correction dans les études d'association citep:marchini2004effects.

- Médecine personnalisé : calcul d'un score de risque génétique pour une maladie citep:Wray_2013.

- Étudier la répartition des populations dans leur habitat citep:Fran_ois_2015.

** Visualisation de la structure génétique des populations avec l'ACP

#+NAME: code:pca
#+CAPTION: Dépend de [[file:~/Projects/Thesis/MaThese/main.org::code:tess3_intro_plot][code:tess3_intro_plot]]
#+begin_src R 
  library(MaTheseR)
  library(ggplot2)
  MaTheseR.params <- get_MaTheseRparams()

  pl <- readRDS("../OUTPUT/Expr/tess3_intro_pca_toprint.rds") + 
    theme(legend.position = "right") +
    ylab("Composante\nprincipale 2") +
    theme(panel.background = element_rect(fill = "transparent", colour = NA),
          plot.background = element_rect(fill = "transparent", colour = NA),
          legend.box.background = element_rect(fill = "transparent", colour = NA),
          legend.background = element_rect(fill = "transparent", colour = NA))

  ThesisRpackage::Plots_export_tikz_pdf(pl,
                                        basename.output = "tess3_intro_pca_slides",
                                        env = MaTheseR.params,
                                        height = 2.5,
                                        width = 5)
#+END_SRC

#+BEGIN_SRC shell
  cd ~/Projects/Thesis/MaThese/OUTPUT/Rplots/

  inkscape \
      --without-gui \
      --file=tess3_intro_pca_slides.pdf \
      --export-plain-svg=tess3_intro_pca_slides.svg
#+END_SRC

#+CAPTION:Scores des deux premières composantes principales calculées sur des données de SNPs d'invidus humains de populations européenne, africaine et afro-américaine.
#+ATTR_HTML: :align center :style width:80%
[[file:../OUTPUT/Rplots/tess3_intro_pca_slides.svg]]

** Le modèle du logiciel =structure= citep:Pritchard2000

#+HTML: <div style="float:left;width:50%;margin-top:50px;">
#+LATEX: \begin{columns}
#+LATEX: \begin{column}{0.5\columnwidth}

#+BEGIN_EXPORT latex
\begin{figure}[th!]
\def\svgwidth{\linewidth}
\input{structure_inkscape.pdf_tex}
\caption{Illustration du modèle de structure génétique de population.}
\end{figure}
#+END_EXPORT

#+HTML: </div>
#+LATEX: \end{column}
#+LATEX: \begin{column}{0.5\columnwidth}
#+HTML: <div style="float:left;width:50%;margin-top:50px;">

\begin{equation*}
\Pr(\Y_{i,\ell} = j) = \sum_{k = 1}^{K} \matr{G}_{(d + 1)\ell + j, k} \Q_{i,k},
\end{equation*}
où 
- $\Pr(\Y_{i,\ell} = j)$ est la probabilité d'observer l'allèle $j$ au locus
  $\ell$ chez l'individu $i$
- $\matr{G}_{(d + 1)\ell + j, k}$ est la fréquence d'apparition de
  l'allèle $j$ au locus $\ell$ dans le groupe génétique $k$.
- $\matr{Q}_{i, k}$ est la proportion de gènes de l'individu $i$
  provenant du groupe $k$.

#+HTML: </div>
#+LATEX: \end{column}
#+LATEX: \end{columns}
** Méthodes d'estimation des coefficients de métissage

#+LATEX: \begingroup\small
#+LATEX: \rowcolors{2}{contiYellow!5}{contiYellow!20}
#+ATTR_LATEX: :align l|p{4cm}p{3cm}|p{3cm}
#+ATTR_HTML: :class TFtable
|---------------+-----------------------------------------+---------------------------------------------------+----------------------|
| Méthode       | Modèle                                  | Algorithme                                        | Référence            |
|---------------+-----------------------------------------+---------------------------------------------------+----------------------|
| STRUCTURE     | bayésien                                | MCMC                                              | citet:Pritchard2000  |
| FRAPPE        | vraisemblance                           | EM                                                | citet:Tang_2005      |
| ADMIXTURE     | vraisemblance                           | optimisation quasi-Newton alternée                | citet:Alexander_2011 |
| fastStructure | bayésien                                | inférence variationnelle bayésienne               | citet:Raj_2014       |
| PSIKO         | ACP                                     | SVD                                               | citet:Popescu_2014   |
| sNMF          | factorisation matricielle parcimonieuse | optimisation quadratique alternée avec projection | citet:Frichot_2014   |
#+LATEX:\rowcolors{2}{}{}
#+LATEX: \endgroup

** Visualisation des coefficients de métissage

#+NAME: code:pca
#+CAPTION: Dépend de [[file:~/Projects/Thesis/MaThese/main.org::code:tess3_intro_plot][code:tess3_intro_plot]]
#+begin_src R 
  library(MaTheseR)
  library(ggplot2)
  MaTheseR.params <- get_MaTheseRparams()

  pl <- readRDS("../OUTPUT/Expr/tess3_intro_barplot_toprint.rds")

  ThesisRpackage::Plots_export_pdf(pl,
                                   basename.output = "tess3_intro_barplot_slides",
                                   env = MaTheseR.params,
                                   height = 2,
                                   width = 5)
#+end_src

#+CAPTION: Estimation par le logiciel =snmf= citep:Frichot_2014 des coefficients de métissage pour un jeu de données composé d'individus humains provenant de populations européenne, africaine et afro-américaine.
[[file:../OUTPUT/Rplots/tess3_intro_barplot_slides.pdf]]

** Données géographiques

#+NAME: code:map
#+CAPTION: Dépend de rien
#+begin_src R 
  library(MaTheseR)
  library(tidyverse)
  library(ggmap)
  MaTheseR.params <- get_MaTheseRparams()
  gtheme <- MaTheseR.params$gtheme


  ## load coord
  ## data.file <- "../Data/AthalianaGegMapLines/call_method_75/call_method_75_TAIR9.RData"
  ## load(data.file)
  ## coord <- call_method_75_TAIR9.europe$coord
  ## rm(call_method_75_TAIR9.europe)
  ## saveRDS(coord, "../Data/AthalianaGegMapLines/call_method_75/call_method_75_TAIR9_coord.rds")
  ## gc()
  coord <- readRDS("../Data/AthalianaGegMapLines/call_method_75/call_method_75_TAIR9_coord.rds") 


  ## plot
  toplot <- as_tibble(coord)
  map.world <- ggmap::get_map(location =  c(left = -16, bottom = 42, right = 33, top = 67),
                              maptype = "watercolor")

  pl <- ggmap(map.world) +
    geom_point(data = toplot, mapping = aes(x = long, y = lat), color = "red", size = 0.25) +
    scale_size_continuous(guide = FALSE) +
    xlab("Longitude") +
    ylab("Latitude") +
    MaTheseR.params$gtheme


  save_expr(pl, "tess3_intro_map_slides_toplot.rds")
  ThesisRpackage::Plots_export_pdf(pl,
                                   basename.output = "tess3_intro_map_slides",
                                   env = MaTheseR.params,
                                   height = 3,
                                   width = 3)
#+end_src

#+ATTR_LATEX: :height 0.9\textheight :width nil
[[file:../OUTPUT/Rplots/tess3_intro_map_slides.pdf]]

** Méthodes d'estimation des coefficients de métissage à l'aide de données géographique

#+LATEX: \rowcolors[]{2}{contiYellow!5}{contiYellow!20}
#+ATTR_LATEX: :align l|p{4cm}p{3cm}|p{3cm}
|--------------+--------------------------------------------------+-----------------------------------+----------------------|
| Méthode      | Modèle                                           | Algorithme                        | Référence            |
|--------------+--------------------------------------------------+-----------------------------------+----------------------|
| TESS         | bayésien                                         | MCMC                              | citet:CHEN_2007      |
| GENELAND     | bayésien                                         | MCMC                              | citet:phdGuedj       |
| BAPS         | bayésien                                         | optimisation stochastique         | citet:Corander2008   |
| *TESS3-AQP*  | factorisation matricielle régularisée sur graphe | optimisation quadratique alternée |                      |
| *TESS3-APLS* | factorisation matricielle régularisée sur graphe | moindres carrés alternés projetés |                      |
| conStruct    | bayésien                                         | MCMC                              | citet:Bradburd189688 |
#+LATEX:\rowcolors{2}{}{}

** Estimation des matrices d'ascendance génétique

Ajouter un petit dessin de factorisation de matrice !!! se mettre sur 2 colonnes

citet:Frichot_2014 cherchent à décomposer la matrice de génotype :

\begin{equation*}
\Y = \Q \mathbf{G}^{T},
\end{equation*}

où

\begin{equation*}
\Q \geq 0 \, , \quad \sum_{k=1}^K {\bf Q}_{i,k} = 1, \quad i = 1...n
\end{equation*}

et

\begin{equation*}
\mathbf{G} \geq 0 \, , \quad \sum_{j=0}^{d} {\bf G}_{(d+1)\ell + j, k} = 1, \quad \ell = 1...p.
\end{equation*}

** Information géographique
*** graph
:PROPERTIES:
:BEAMER_col: 0.5
:END:

#+NAME: code:map_graph_print
#+CAPTION: Dépend de [[code:map]] [[code:map_graph]]
#+begin_src R 
  library(MaTheseR)
  library(tidyverse)
  library(ggmap)
  MaTheseR.params <- get_MaTheseRparams()
  gtheme <- MaTheseR.params$gtheme

  ## load coord
  coord <- readRDS("../Data/AthalianaGegMapLines/call_method_75/call_method_75_TAIR9_coord.rds") 

  ## graph.df <- readRDS("../OUTPUT/Expr/slide_graph_df.rds")
  graph.df <- tibble()
  long <- c(0,10,15,3,16,-3, 18)
  lat <- c(52,50,56,45,47,54,63)
  n <- length(lat)
  W.adj <- matrix(TRUE, n,n)
  for (i in 1:n) {
    graph.df <- graph.df %>%
      rbind(tibble(longend = long[W.adj[i,]], latend = lat[W.adj[i,]], long = long[i], lat = lat[i]))
  }

  ## plot
  pl <- readRDS("../OUTPUT/Expr/tess3_intro_map_slides_toplot.rds") +
    geom_segment(aes(x = long, y = lat, xend = longend, yend = latend),
                 color = "red",
                 data = graph.df)

  ThesisRpackage::Plots_export_pdf(pl,
                                   basename.output = "tess3_intro_map_graph_slides",
                                   env = MaTheseR.params,
                                   height = 3,
                                   width = 3)
#+end_src

[[file:../OUTPUT/Rplots/tess3_intro_map_graph_slides.pdf]]

**** Script                                                     :noexport:
#+NAME: code:map_graph
#+CAPTION: Dépend de rien
#+begin_src R :session *krakR* :results output :dir /scp:cayek@krakenator:~/Projects/Thesis/MaThese/
  library(MaTheseR)
  library(tidyverse)

  ## load coord
  coord <- readRDS("../Data/AthalianaGegMapLines/call_method_75/call_method_75_TAIR9_coord.rds")
  n <- nrow(coord)
  coord.smpl <- coord[sample(n, 300), ]
  n <- nrow(coord.smpl)

  ## graph
  library(tess3r)
  W <- tess3r::ComputeHeatKernelWeight(coord.smpl, 1.5)
  hist(W)
  W.adj <- matrix(FALSE, n, n)
  th2 <- 0.4
  th1 <- 0.1
  W.adj[th1 <= W & W <= th2] <- TRUE
  sum(W.adj)

  graph.df <- tibble()
  long <- coord.smpl[,"long"] %>% as.numeric()
  lat <- coord.smpl[,"lat"] %>% as.numeric()
  for (i in 1:n) {
    graph.df <- graph.df %>%
      rbind(tibble(longend = long[W.adj[i,]], latend = lat[W.adj[i,]], long = long[i], lat = lat[i]))
  }

  save_expr(graph.df, "slide_graph_df.rds")

  pl <- readRDS("./OUTPUT/Expr/tess3_intro_map_slides_toplot.rds")

  pl + geom_segment(aes(x = long, y = lat, xend = longend, yend = latend, colour = "segment"), data = graph.df)
#+end_src

*** formule
:PROPERTIES:
:BEAMER_col: 0.5
:END:

Entre chaque individu $i$ et $j$, nous avons le poids de graphe
\begin{equation*}
\W_{i,j} = \exp( - {\rm dist}( x_i, x_j )^2/ \sigma^2)
\end{equation*}

où la fonction ${\rm dist}( x_i, x_j)$ est une distance entre les coordonnées géographique $x_{i}$ et $x_{j}$. 

Ensuite, nous introduisons la régularisation
\begin{equation*}
\frac{1}{2} \sum_{i,j = 1}^n  \W_{i,j}  \| \Q_{i,.} - \Q_{j,.} \|^2
\end{equation*}

La régularisation peut se réécrire 
\begin{equation*}
{\rm Tr} (\Q^{T} \matr{\Gamma} \Q)
\end{equation*}

** Problème d'optimisation des moindres carrés

Pour estimer les matrice d'ascendance on cherche à optimiser la fonction 

\begin{equation*}
\mathcal{L}(\Q, \mathbf{G}) =   \|  {\bf Y} - {\bf QG}^T \|^2_{\rm F} +  \alpha {\rm Tr} (\Q^{T} \matr{\Gamma} \Q)
\end{equation*}

** Algorithme de descente par blocs de coordonnées
*** graphe
:PROPERTIES:
:BEAMER_col: 0.5
:END:
#+CAPTION: Illustration de l'algorithme de descente par blocs de coordonnées.
[[file:../OUTPUT/Rplots/coordinate_descente.pdf]]

*** test                                                            :BMCOL:
:PROPERTIES:
:BEAMER_col: 0.5
:END:

On alterne deux étapes jusque convergence vers un point critique : 

- optimisation de $\mathcal{L}$ selon $\Q$ avec $\matr{G}$ fixé
- optimisation de $\mathcal{L}$ selon $\matr{G}$ avec $\Q$ fixé

*Nous présentons deux algorithmes utilisant ce principe.*

** Algorithme d'optimisation quadratique alternée (AQP)           :noexport:

On alterne des optimisation de problème quadratiques 

- Calcul de $\matr{G}$ 
\begin{equation} 
\begin{aligned}
\mathbf{G} = \underset{g \in \DG}{\arg \min} ( -2  v^T_Q \, g + g^T \D_{Q} g ) ,
\label{eq:AQPg}
\end{aligned}
\end{equation}

- Calcul de $\Q$ 
\begin{equation} 
\begin{aligned}
\Q = \underset{q \in \DQ}{\arg \min} ( -2 v^T_G \, q + q^T \D_{G} q ) ,
\label{eq:AQPq}
\end{aligned}
\end{equation}

D'après citet:Grippo_2000, on a le théorème suivant

#+BEGIN_theorem
<<AQP_theorem>> L'algorithme AQP qui alterne les étapes d'optimisation des
problèmes eqref:eq:AQPg et eqref:eq:AQPq converge vers un minimum local de la
fonction $\LS$.
#+END_theorem

** Algorithme des moindres carrés alternés projetés (APLS)        :noexport:

On retire les contraintes des problèmes d'optimisations.

- Calcul de $\matr{G}$
\begin{equation*}
{\bf G} = \arg \min  \|  {\bf Y} - {\bf QG}^T \|^2_{\rm F} \, .
\end{equation*}
  projection de $\matr{G}$ sur $\DG$

- Calcul de $\Q$ 
  \begin{equation}
  \label{eq:tess3:apls:q}
  q_i^\star = \arg \min \| \mathcal{P}(\Y)_i - \mathbf{G} q \|^{2}_{2} + \alpha \lambda_i \| q \|^{2}_{2}  ,
  \end{equation}


  projection de $\matr{Q}$ sur $\DQ$

Il n'y a pas de résultats sur la convergence. *Mais* nous avons observé que APLS
fournis de bonnes approximation de AQP.

** Algorithme de descente par blocs de coordonnées
*** Algorithme d'optimisation quadratique alternée (AQP)

- D'après citet:Grippo_2000, AQP converge vers un minimum local de la fonction
  objectif $\LS$
- L'étape de calcul de $\Q$ implique de résoudre un problème d'optimisation
  convexe de taille $n \times K$

*** Algorithme des moindres carrés alternés projetés (APLS)

- L'étape de calcul de $\Q$ peut être séparé en $n$ moindres carré régularisé en
  norme $L_2$
- Il n'y a pas de garantit théorique sur la convergence
- Dans nos comparaisons, APLS fourni de bonnes approximations de AQP tout en
  étant plus rapide

*Nous utilisons APLS dans la suite*

** Simulation de génotypes métissés spatialement
*** graphe
:PROPERTIES:
:BEAMER_col: 0.5
:END:

#+BEGIN_EXPORT latex
\begin{figure}[th!]
\def\svgwidth{\linewidth}
\input{cline_inkscape.pdf_tex}
\end{figure}
#+END_EXPORT
*** texte                                                           :BMCOL:
:PROPERTIES:
:BEAMER_col: 0.5
:END:

- La matrice $\matr{G}$ est simulée par un modèle de Wright à deux îles
- La matrice $\Q$ est simulée selon un gradient longitudinal
- Ma matrice $\Y$ est générée en tirant des gènes des deux populations sources
  avec des probabilités données par les coefficient de métissage

On simule plusieurs génotype pour avoir plusieurs valeur de différenciation
mesuré par 
\begin{equation*}
F_{\rm ST} = \frac{1}{1 + 4N_0 m}
\end{equation*}

** Comparaison avec une méthode bayésienne TESS 2.3

#+BEGIN_EXPORT latex
\begin{figure}[!t]
\centering
\begin{minipage}{0.49\textwidth}
  \includegraphics[height=0.7\textheight]{../OUTPUT/Rplots/tess3_tess2_3_rmseG.pdf}
\end{minipage}
\begin {minipage}{0.49\textwidth}
  \includegraphics[height=0.7\textheight]{../OUTPUT/Rplots/tess3_tess2_3_rmseQ.pdf}
\end{minipage}
\caption{{\bf Racine de l'erreur quadratique moyenne (RMSE) pour l'estimation de
    $\Q$ (figure A) et $\mathbf{G}$ (figure B).}}
\end{figure}    
#+END_EXPORT
** Application à des données /Arabidopsis Thaliana/

On étudie 214k SNPs pour 1 095 écotypes européens des espèces végétales
/A.thaliana/ citep:Horton_2012.
*** fleur
:PROPERTIES:
:BEAMER_col: 0.5
:END:
#+ATTR_LATEX: :width nil :height 0.48\textheight
[[file:img/a_thaliana.jpg]]

*** carte                                                           :BMCOL:
:PROPERTIES:
:BEAMER_col: 0.5
:END:

[[file:../OUTPUT/Rplots/tess3_intro_map_slides.pdf]]

** Choix des paramètres

#+NAME: code:tess3_AT_params
#+CAPTION: Dépend de [[file:~/Projects/Thesis/MaThese/main.org::code:tess3_AT_params][code:tess3_AT_params]]
#+begin_src R :session *R* :dir ~/Projects/Thesis/MaThese/ :results silent
  library(MaTheseR)
  MaTheseR.params <- get_MaTheseRparams()

  pl <- readRDS("../OUTPUT/Expr/tess3_AT_params_plot.rds")

  ThesisRpackage::Plots_export_tikz_pdf(pl,
                                        basename.output = "tess3_AT_params_slides",
                                        env = MaTheseR.params,
                                        height = 3,
                                        width = 6.3)
#+end_src


#+CAPTION: Choix de $\sigma$ et $K$ pour l'algorithme APLS
[[file:../OUTPUT/Rplots/tess3_AT_params_slides.pdf]]

** Carte des coefficients de métissage

#+NAME: code:at_map_Q
#+CAPTION: Dépend de [[file:~/Projects/Thesis/MaThese/main.org::code:tess3_AT_map][code:tess3_AT_map]]
#+begin_src R 
  mappl <- readRDS("../OUTPUT/Expr/tess3_at_map.rds")

  ThesisRpackage::Plots_export_pdf(mappl,
                                   basename.output = "tess3_AT_map_slides",
                                   env = MaTheseR.params,
                                   height = 3,
                                   width = 5.2)
#+end_src

[[file:../OUTPUT/Rplots/tess3_AT_map_slides.pdf]]

* Algorithmes d'estimation pour les modèles de régression à facteurs latents
:PROPERTIES:
:REVEAL_EXTRA_ATTR: slide-title="Étude d'association"
:END:
** Test d'association
c'est quoi 
pk c'est important 
on motive
** Étude d'association entre des données génétiques et un gradient environnemental 

#+NAME: code:lfmm_map
#+CAPTION: Dépend de [[file:~/Projects/Thesis/MaThese/main.org::code:eas_climatic_gradient][code:eas_climatic_gradient]]
#+begin_src R 
  library(MaTheseR)
  library(ggmap)
  MaTheseR.params <- get_MaTheseRparams()


  indiv.df <- readRDS("../Data/ThesisDataset/3Article/1000GenomesPhase3/EAS_indiv_df_2.rds")

  map.world <- ggmap::get_map(location = c(left = -50, bottom = -50, right = 100, top = 70),
                              maptype = "watercolor")

  pl <- ggmap(map.world) +
    geom_point(data = indiv.df,
               mapping = aes(x = lon, y = lat, color = X),
               size = 1) +
    MaTheseR.params$gtheme +
    theme(panel.background = element_rect(fill = "transparent", colour = NA),
          plot.background = element_rect(fill = "transparent", colour = NA),
          legend.background = element_rect(fill = "transparent", colour = NA)) +
    scale_colour_gradient(low = "chartreuse1",
                        high = "firebrick1") + 
    xlab("Longitude") +
    ylab("Latitude")
  pl

  save_expr(pl, "lfmm_intro_map_covariate_slides_toplot.rds")

  ThesisRpackage::Plots_export_pdf(pl,
                                   basename.output = "lfmm_intro_map_covariate_slides",
                                   env = MaTheseR.params,
                                   height = 3,
                                   width = 3)
  ggsave("../OUTPUT/Rplots/lfmm_intro_map_covariate_slides.png",
         pl,
         width = 300 * 0.01041666666667,
         height = 200 * 0.01041666666667,
         dpi = 300,
         units = "in",
         bg = "transparent")
#+end_src

[[file:../OUTPUT/Rplots/lfmm_intro_map_covariate_slides.png]]

*** map

*** text

** Exemple d'une étude d'association avec les données /Arabidopsis Thaliana/ :noexport:
*** map                                                             :BMCOL:
:PROPERTIES:
:BEAMER_col: 0.5
:END:
#+NAME: code:AT_covariate_plot
#+CAPTION: Dépend de [[code:AT_covariate]]
#+begin_src R 
  library(MaTheseR)
  library(tidyverse)
  library(ggmap)
  library(broom)
  MaTheseR.params <- get_MaTheseRparams()
  gtheme <- MaTheseR.params$gtheme

  ## load data
  X <- readRDS("../Data/AthalianaGegMapLines/call_method_75/X_worldclim.rds")
  coord <- readRDS("../Data/AthalianaGegMapLines/call_method_75/call_method_75_TAIR9_coord.rds") 


  ## plot
  toplot <- coord %>%
    cbind(X = X) %>%
    as_tibble()
  map.world <- ggmap::get_map(location =  c(left = -16, bottom = 42, right = 33, top = 67),
                              maptype = "watercolor")

  cor(toplot)
  lm.df <- lm(X ~ lat + long - 1, data = toplot) %>%
    broom::tidy()
  lm.df


  pl <- ggmap(map.world) +
    geom_point(data = toplot, mapping = aes(x = long, y = lat, color = X), size = 0.25) +
    xlab("Longitude") +
    ylab("Latitude") +
    scale_colour_gradient(low = "chartreuse1",
                          high = "firebrick1") +
    MaTheseR.params$gtheme


  save_expr(pl, "tess3_intro_map_covariate_slides_toplot.rds")
  ThesisRpackage::Plots_export_pdf(pl,
                                   basename.output = "tess3_intro_map_covariate_slides",
                                   env = MaTheseR.params,
                                   height = 3,
                                   width = 3)
#+end_src

#+ATTR_LATEX: :height 0.9\textheight :width nil
[[file:~/Projects/Thesis/MaThese/OUTPUT/Rplots/tess3_intro_map_covariate_slides.pdf]]
*** text                                                            :BMCOL:
:PROPERTIES:
:BEAMER_col: 0.5
:END:

- On récupère des données climatiques à partir de la base données worldclim. 

- La covariable $\matr{X}$ est fabriquée en prenant la première composante
  principale de plusieur 

**** Scripts                                                    :noexport:
#+NAME: code:AT_covariate
#+CAPTION: Dépend de rien
#+begin_src R :session *krakR* :results output :dir /scp:cayek@krakenator:~/Projects/Thesis/MaThese/
  library(MaTheseR)

  ## load data
  data.file <- "./Data/AthalianaGegMapLines/call_method_75/call_method_75_TAIR9.RData"
  load(data.file)
  coord <- call_method_75_TAIR9.europe$coord
  rm(call_method_75_TAIR9.europe)
  gc()

  ## get climatic gradient
  ## worldclim : http://www.worldclim.org/formats1
  ## getdata in R: http://www.gis-blog.com/r-raster-data-acquisition/
  library(raster)
  climate <- raster::getData('worldclim', var='bio', res = 2.5)
  bio <- extract(climate, y = coord)
  pc.bio <- prcomp(bio,scale = T)
  plot(pc.bio$sdev)
  X <- pc.bio$x[,1]

  saveRDS(X, "./Data/AthalianaGegMapLines/call_method_75/X_worldclim.rds")

#+end_src

** Modèle de régression linéaire
Y = X B^T
stat de student
** Étude d'association entre des données génétiques et un gradient environnemental

#+NAME: code:lfmm_qqplot
#+CAPTION: Dépend de 
#+begin_src R :session *krakR* :results output :dir /scp:cayek@krakenator:~/Projects/Thesis/MaThese/
  library(tidyverse)
  library(MaTheseR)
  library(cowplot)
  library(gridExtra)
  library(scales)
  MaTheseR.params <- get_MaTheseRparams()
  method.ordered <- MaTheseR.params$method.ordered
  color.values <- MaTheseR.params$color.values
  gtheme <- MaTheseR.params$gtheme

  ## res
  res.df <- readRDS("./OUTPUT/Expr/Eas_df_lm_2049b91fd6d2c9798533d7ebed94e547.rds")

  pl.qq <- ggplot(res.df, aes(sample = -log10(pvalue), color = method)) +
    stat_qq(distribution = stats::qexp, dparams = list(rate = log(10))) +
    geom_abline(slope = 1, intercept = 0) +
    scale_color_manual(name = "Méthodes", values = color.values) + 
    theme(legend.position="bottom") +
    xlab("Quantiles théoriques") +
    ylab("Quantiles observés")

  pl.qq


#+end_src

** Modèles de régression à facteurs latents 
Le petit graph et les equations
** Méthodes d'estimation pour les modèles de régression à facteurs latents
tableau
** Estimateur des moindres carrées régularisé en norme L2
*Fonction objectif*

\begin{equation}
\Lridge(\matr{U}, \V, \B) =  \frac{1}{2} \norm{\Y - \matr{U} \V^{T} - \X \B^T}_{F}^2 +
\frac{\lambRidge}{2} \norm{\B}^{2}_{2}%
\end{equation}

*Algorithme*

\begin{align}
\label{eq:RidgeLfmmEstomatorW}
\hat{\matr{U}} \hat{\V}^{T} & =  \matr{Q} \Dlambda^{-1} \svd_{\K}( \Dlambda \matr{Q}^{T} \Y ) \\
\label{eq:RidgeLfmmEstomatorB}
\hat{\B}^{T} & = (\X^{T} \X + \lambRidge \Id_{d})^{-1} \X^{T} (\Y - \hat{\matr{U}} \hat{\V}^{T}),
\end{align}

*théorème*

Pour $\lambRidge$ strictement supérieur à zéro, les
estimateurs des paramètres de LFMM régularisés en norme $L_{2}$, définis par
eqref:eq:RidgeLfmmEstomatorW et eqref:eq:RidgeLfmmEstomatorB, définissent un
minimum global de la fonction objectif $\Lridge$.

** Estimateur des moindres carrées régularisé en norme L1
*Fonction objectif*
\begin{equation}
\Llasso(\W, \B) =  \frac{1}{2} \norm{\Y - \W - \X \B^T}_{F}^2 +
\lambLasso \norm{\B}_{1} + \gamma \norm{\W}_{*}
\end{equation}
*Algorithme*
1. Calculer $\hat{\B}_{t}$ le point minimum de 
   \begin{equation}
   \label{eq:lasso1}
   \mathcal{L}_{\mathrm{lasso}}^{'}(\B) =  \frac{1}{2} ||(\Y - \hat{\W}_{t-1}) - \X \B^T||_{F}^2 + \lambLasso ||\B||_1
   \end{equation}
2. Calculer $\hat{\W}_{t}$ le point minimum de  
   \begin{equation}
   \label{eq:lasso2}
   \mathcal{L}_{\mathrm{lasso}}^{''}(\W) = \frac{1}{2} ||(\Y - \X \hat{\B}_t^T)- \W ||_{F}^2 + \gamma ||\W||_{*}.
   \end{equation}
*Théorème*

...

** Tests d'hypothèse corrigés pour les facteurs de confusion
calcul de la pvalue (on parle pas la calibration ici). On dit ici que la pvalue
c'est le score de signifiance et blabla.
** Données simulées
il faut trouver un moyen simple d'expliquer comment j'ai simulé, mettre l'accent
sur le paramètre de corrélation
** Comparaison des méthodes sur des données simulées
Montrer les résultats pour différent paramètre de régularisation
** Étude d'association entre des données génétiques et un gradient environnemental
présentation des données, carte
** Étude d'association entre des données génétiques et un gradient environnemental
décrire l'experience, on va parler ici des méthodes qu'on a lancé et de la
calibration des tests et de la qvalue !!!
** Choix du nombre de variables latentes
On présente la procédure, c'est a dire transformation des données pour enlever
Y. (Méthode qui vient de cate, a vérifier mais je crois pas).
** Choix du nombre de variables latentes
le scree plot
** Choix du nombre de variables latentes
les plots étoiles
** Comparaison des résultats 
diagramme de venne
** Annotation de l'union des candidats 
sur représentation
et
tableau ?
** EWAS
* Conclusions
:PROPERTIES:
:REVEAL_EXTRA_ATTR: slide-title="Conclusions et perspectives"
:END:
** Deux logiciels                                                 :noexport:
tess3r et lfmm
de la factorisation de matrices
** =tess3r=

- Nouveau modèle pour l'estimation de la structure génétique des populations à
  partir de données génétique et géographique
- Deux algorithmes pour l'inférence des paramètres
- Même precision statistique que le logiciel bayesien  =TESS= 2.3 
- Algorithme 30 fois plus rapide que =TESS= 2.3
- Visualisation de la strucuture génétique de population dans l'espace

#+begin_src R :exports both
  # install.packages("devtools")
  devtools::install_github("bcm-uga/TESS3_encho_sen")
#+end_src

** =lfmm=

- Deux nouveaux algorithmes d'estimation pour les modèles de régression à facteur
  latents
- Résultats théorique sur la convergence des algorithmes
- Sur les simulations même puissance que l'oracle et que la méthode cate
- Sur des données réelles les méthodes reposant sur le modèle de regression à
  facteurs latents découvre plus d'association.
- Sur les données réelles les associassions découvertes peuvent varier largement
  entre les méthodes

#+begin_src R :exports both
  # install.packages("devtools")
  devtools::install_github("bcm-uga/lfmm")
#+end_src

** perspectives                                                   :noexport:
- perspective de maintient des logiciel 
- utilisation d'approche basé sur la factorisation matriciel à d'autre étude, 
ex RNA-Seq et données méthylation au débit => s'attendre a des questions
* Merci de votre attention
* Bibliography
bibliography:../biblio.bib
